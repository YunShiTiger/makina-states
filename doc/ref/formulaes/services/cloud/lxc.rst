LXC provision
======================

As always, the configuration is done via a registry: :ref:`module_mc_lxc`.

To provision a new lxc provider, you need to:

    - Select a size profile and a type profile
    - add an entry to your lxc container in pillar reflecting those choices plus
      the other vm parameters.

* You can either start an lxc from scratch or begin with a template like a barebone ubuntu which will be cloned at a start.
* By default, we use the **10.5/16** network for all containers
* This use the **lxcbr1** bridge.
* The default gateway is **10.5.0.1**
* We use **LVM** as the default backing store, and the **data** volume group.
* Salt cloud profiles are just collections of default for your next provision.

 * The naming scheme is ms-**{encoded minion id}**-**{size profile}**-**{profile type}**, eg profiles::

    ms-devhost-10-local-small-dir
    ms-devhost-10-local-small-lvm
    ms-devhost-10-local-medium-dir
    ms-devhost-10-local-medium-lvm

* Those are the availables modes:

    :salt: cf saltity modes
    :mastersalt: cf saltity modes

* Those are the sizes available in profiles

        :xxxtrem: 2000g
        :xxtrem: 1000g
        :xtrem: 500g
        :xxxlarge: 100g
        :large: 20g
        :medium: 10g
        :small: 5g
        :xsmall: 3g
        :xxsmall: 1g
        :xxxsmall: 500m

* Those are the types available in profiles

    :lvm-sratch: starting a lxc container from scratch (lvm backing)
    :dir-scratch:  starting a lxc container from scratch (directory backing)
    :lvm (default): cloning from existing container (lvm backing)
    :dir: cloning from existing container (directory backing)


The idea is to add to your specific minion pillar some lxc entries as follow:

.. code-block:: yaml

  makina-states.services.virt.lxc.containers.devhost10.local:
    mysupertest4:
      name: gfoobar.test.com
      profile: small
      profile_type: lvm
      password: foobar
      ip: 10.5.10.16
    mysupertest4:
      name: gfoobar2.test.com
      ip: 10.5.10.15
      profile: small
      mode: mastersalt
      profile_type: lvm
      password: foobar

* The first line ends (after **containers.**) with your targeted minion id, where the lxc containers will be installed.
* You have to assign the ip yourself to something that will be in the **10.5/16** network or the targeted minion
* MAC is autogenerated, so you dont need to give one
* And the inner mappings define the container themselves.
* Please note that the name in makina-corpus way must be the NickName FQDN.
* Please do not use **snapshot** in production.

to destroy at once boxes and minion keys on master::

    salt-cloud -d <name>

