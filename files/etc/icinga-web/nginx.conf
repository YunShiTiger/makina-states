# MANAGED VIA SALT -- DO NOT EDIT
#{% set data = salt['mc_utils.json_load'](data) %}
http {
server {
    listen 80;
    server_name {{data.nginx.virtualhost}};

    rewrite ^(.*) https://$server_name:443$1 permanent;
}

server {
    listen 443;
    server_name {{data.nginx.virtualhost}};

    error_log /var/log/nginx/icinga-web_error.log;

    ssl			on;
    ssl_certificate	/etc/ssl/certs/icinga.pem;
    ssl_certificate_key	/etc/ssl/private/icinga.key;

    index index.php index.html index.htm;

    location = /favicon.ico {
        log_not_found off;
        access_log off;
        expires max;
    }

    location = /robots.txt {
        allow all;
        log_not_found off;
        access_log off;
    }

    # Deny access to hidden files
    location ~ /\. {
        deny all;
        access_log off;
        log_not_found off;
    }
    location = / {
        rewrite ^/$ /icinga-web/index.php permanent;
    }
    location /icinga-web/styles {
        alias /usr/local/icinga-web/pub/styles;
    }
    location /icinga-web/images {
        alias /usr/local/icinga-web/pub/images;
    }
    location /icinga-web/js {
        alias /usr/local/icinga-web/lib;
    }
    location /icinga-web/modules/([A-Za-z0-9]*)/resources/images/([A-Za-z_\-0-9]*\.(png|gif|jpg))$ {
        alias /usr/local/icinga-web/app/modules/$1/pub/images/$2;
    }
    location /icinga-web/modules/([A-Za-z0-9]*)/resources/styles/([A-Za-z0-9]*\.css)$ {
        alias /usr/local/icinga-web/app/modules/$1/pub/styles/$2;
    }
    location /icinga-web/modules/BPAddon/resources {
        alias /usr/local/icinga-web/app/modules/BPAddon/pub;
    }
    location /icinga-web/modules {
        rewrite ^/icinga-web/(.*)$ /icinga-web/index.php?/$1 last;
    }
    location /icinga-web/web {
        rewrite ^/icinga-web/(.*)$ /icinga-web/index.php?/$1 last;
    }
    location ~ ^/modules {
        rewrite ^/modules/(.*)$ /icinga-web/modules/$1 permanent;
    }
    location /icinga-web {
        alias   /usr/local/icinga-web/pub;
        index index.php;
        try_files $uri $uri/ /icinga-web/index.php?$args;
    }
    location ~ /icinga-web/(.*)\.php($|/) {
        include /etc/nginx/fastcgi_params;
        fastcgi_pass unix:{{data.phpfpm.listen}};
        fastcgi_index index.php;
        fastcgi_split_path_info ^(/icinga-web/.*\.php)(.*);
        fastcgi_param PATH_INFO $fastcgi_path_info;
        fastcgi_param SCRIPT_FILENAME /usr/local/icinga-web/pub/index.php;
    }

}
}
