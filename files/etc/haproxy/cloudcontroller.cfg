{% set cdata = cdata|load_yaml %}
{% macro bck(data) %}
backend {{data.name}}
    mode {{data.get('mode', 'http')}}
{% for opt in data.get('raw_opts', []) %}
    {{opt}}
{% endfor %}
{% for srv in data.get('servers', []) %}
    server {{ srv.name }} {{srv.bind}} {{srv.opts}}
{% endfor %}
{% endmacro %}

{% macro ssh_reverse(data) %}
listen {{data.name}}
    mode {{data.get('mode', 'http')}}
    bind {{data.bind}}
{% for opt in data.get('raw_opts', []) %}
    {{opt}}
{% endfor %}
{% for srv in data.get('servers', []) %}
    server {{ srv.name }} {{srv.bind}} {{srv.opts}}
{% endfor %}
{%endmacro %}

{% macro http_middle_proxy(data) %}
listen {{data.name}}
    mode {{data.get('mode', 'http')}}
    bind {{data.bind}}
{% for opt in data.get('raw_opts', []) %}
    {{opt}}
{% endfor %}
{% for srv in data.get('servers', []) %}
    server {{ srv.name }} {{srv.bind}} {{srv.opts}}
{% endfor %}
{%endmacro %}

{% macro front(data) %}
frontend {{data.name}}
    bind {{data.bind}}
    mode {{data.get('mode', 'http')}}
{% for opt in data.get('raw_opts', []) %}
    {{opt}}
{% endfor %}
{%endmacro %}

# http front
{{ front(cdata.http_proxy) }}
{{ front(cdata.https_proxy) }}
# https front
{% for name, backend in cdata.http_backends.items() %}
{{ bck(backend) }}
{% endfor %}
{% for name, backend in cdata.https_backends.items() %}
{{ bck(backend) }}
{% endfor %}
# ssh proxies
{% for backend in cdata.ssh_proxies %}
{{ ssh_reverse(backend) }}
{% endfor %}
