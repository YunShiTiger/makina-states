# MANAGED VIA SALT --  DO NOT EDIT
{% set data = salt['mc_utils.json_load'](data) %}
include {{data.vhost_top_file}};
server {
    listen {{ data.port }};
    listen [::]:{{data.port}}  {% if data.default_server%}default_server {%endif%}ipv6only=on;
    server_name {{ data.server_name }}{% if data.server_aliases %} {{ data.server_aliases|join(' ') }}{% endif %};
    {% if data.redirect_aliases %}
    server_name_in_redirect on;
    {% endif %}
    error_log {{data.data.logdir}}/{{ data.small_name }}-error.log {{data.loglevel}};
    access_log  {{data.data.logdir}}/{{ data.small_name }}-access.log {{data.data.logformat}};
    {% if data.data.use_real_ip and  data.reverse_proxy_addresses %}
    set_real_ip_from  {% for addr in data.reverse_proxy_addresses %} {{addr}}{%endfor%};
    real_ip_header {{data.real_ip_header}};
    {% endif %}
    # Member features should be over ssl
    root {{ data.doc_root }};
    {% if data.allowed_hosts %}
    ## Deny illegal Host headers
    if ($host !~* ^({{ data.allowed_hosts|join('|') }})$ ) {
        return 444;
    }
    {% endif %}
    include {{data.vhost_content_file}};
}
