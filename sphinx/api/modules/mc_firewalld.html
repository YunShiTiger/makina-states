

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>mc_firewalld / firewalld functions &mdash; Makina States 1.0 documentation</title>
  

  
  

  
  <link href='https://fonts.googleapis.com/css?family=Lato:400,700,400italic,700italic|Roboto+Slab:400,700|Inconsolata:400,700&subset=latin,cyrillic' rel='stylesheet' type='text/css'>

  
  
    

  

  
  
    <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  

  

  
    <link rel="top" title="Makina States 1.0 documentation" href="../../index.html"/>
        <link rel="up" title="Execution modules" href="index.html"/>
        <link rel="next" title="mc_dbus / dbus functions" href="mc_dbus.html"/>
        <link rel="prev" title="mc_mvn / mvn registry" href="mc_mvn.html"/> 

  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/modernizr/2.6.2/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-nav-search">
        
          <a href="../../index.html" class="fa fa-home"> Makina States</a>
        
        
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
        
          
          
              <ul class="simple">
</ul>
<ul class="simple">
</ul>
<ul class="current">
<li class="toctree-l1 current"><a class="reference internal" href="../index.html">Custom states modules</a><ul class="current">
<li class="toctree-l2 current"><a class="reference internal" href="index.html">Execution modules</a></li>
<li class="toctree-l2"><a class="reference internal" href="../states/index.html">States modules</a></li>
<li class="toctree-l2"><a class="reference internal" href="../grains/index.html">makina-states grains modules</a></li>
<li class="toctree-l2"><a class="reference internal" href="../api/index.html">Api  modules</a></li>
</ul>
</li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../v1/index.html">Makina-states V1 documentation (OBSOLETE)</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../v1/index.html#usage">Usage</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../v1/index.html#reference">Reference</a></li>
</ul>
</li>
</ul>

          
        
      </div>
      &nbsp;
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../../index.html">Makina States</a>
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../../index.html">Docs</a> &raquo;</li>
      
          <li><a href="../index.html">Custom states modules</a> &raquo;</li>
      
          <li><a href="index.html">Execution modules</a> &raquo;</li>
      
    <li>mc_firewalld / firewalld functions</li>
      <li class="wy-breadcrumbs-aside">
        
          <a href="../../_sources/api/modules/mc_firewalld.txt" rel="nofollow"> View page source</a>
        
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document">
            
  <span class="target" id="module-mc_states.modules.mc_firewalld"></span><div class="section" id="mc-firewalld-firewalld-functions">
<span id="module-mc-firewalld"></span><h1>mc_firewalld / firewalld functions<a class="headerlink" href="#mc-firewalld-firewalld-functions" title="Permalink to this headline">¶</a></h1>
<dl class="function">
<dt id="mc_states.modules.mc_firewalld.add_aliased_interfaces">
<code class="descclassname">mc_states.modules.mc_firewalld.</code><code class="descname">add_aliased_interfaces</code><span class="sig-paren">(</span><em>data=None</em><span class="sig-paren">)</span><a class="headerlink" href="#mc_states.modules.mc_firewalld.add_aliased_interfaces" title="Permalink to this definition">¶</a></dt>
<dd><p>Mark aliases of interfaces to belong to the same interface
of the attached interface, by default</p>
</dd></dl>

<dl class="function">
<dt id="mc_states.modules.mc_firewalld.add_natted_networks">
<code class="descclassname">mc_states.modules.mc_firewalld.</code><code class="descname">add_natted_networks</code><span class="sig-paren">(</span><em>data=None</em><span class="sig-paren">)</span><a class="headerlink" href="#mc_states.modules.mc_firewalld.add_natted_networks" title="Permalink to this definition">¶</a></dt>
<dd><p>Add nat rules if possible on non
public zones</p>
</dd></dl>

<dl class="function">
<dt id="mc_states.modules.mc_firewalld.complete_rich_rules">
<code class="descclassname">mc_states.modules.mc_firewalld.</code><code class="descname">complete_rich_rules</code><span class="sig-paren">(</span><em>rules=None</em>, <em>rule=None</em>, <em>family=None</em>, <em>destinations=None</em>, <em>icmp_block=None</em>, <em>masquerade=None</em>, <em>sources=None</em>, <em>protocols=None</em>, <em>ports=None</em>, <em>forward_ports=None</em>, <em>services=None</em>, <em>endrule=None</em>, <em>audit=None</em>, <em>log=None</em>, <em>log_prefix=None</em>, <em>log_level=None</em>, <em>limit=None</em>, <em>action=None</em><span class="sig-paren">)</span><a class="headerlink" href="#mc_states.modules.mc_firewalld.complete_rich_rules" title="Permalink to this definition">¶</a></dt>
<dd><p>Subroutine of the rich rule helper</p>
</dd></dl>

<dl class="function">
<dt id="mc_states.modules.mc_firewalld.rich_rules">
<code class="descclassname">mc_states.modules.mc_firewalld.</code><code class="descname">rich_rules</code><span class="sig-paren">(</span><em>family='ipv4'</em>, <em>sources=None</em>, <em>source=None</em>, <em>destinations=None</em>, <em>destination=None</em>, <em>services=None</em>, <em>service=None</em>, <em>ports=None</em>, <em>port=None</em>, <em>audit=None</em>, <em>log=None</em>, <em>log_prefix=None</em>, <em>log_level=None</em>, <em>forward_ports=None</em>, <em>forward_port=None</em>, <em>limit=None</em>, <em>icmp_block=None</em>, <em>masquerade=False</em>, <em>action='accept'</em>, <em>public_ips=None</em>, <em>protocols=None</em><span class="sig-paren">)</span><a class="headerlink" href="#mc_states.modules.mc_firewalld.rich_rules" title="Permalink to this definition">¶</a></dt>
<dd><p>Helper to generate rich rules compatibles with firewalld</p>
<p>see firewalld.richlanguage(5) (man)</p>
<dl class="docutils">
<dt>public_ips</dt>
<dd><p class="first">firewalld does make special forward rules relying on packet
marking whenever they macth the port and the source/dest.
This means that it will remap all traffic from an aforementioned rule
matching this port on the public zone to be reentrant and goes to the
destination of the rule instead of the real destination.
Thus to correctly NAT services without limiting outgoing
traffic on the same ports from network branches withing the NAT,
we limit the exposure of the target rules to the public
facing ips of the underlying host.
This also means, that logically, as nearly always with natted
services, network access points from within the NAT
cant access the services as if they would be outside of the NAT.
Technically speaking, in case of forward ports, we only apply the rule
on the public facing address (aka addresses of interfaces which are
linked to the public zones) by limitating the rule scopes to those
destinations.</p>
<p>public_ips is indeed a list of ips, which if empty or None will
be computed from host network informations.</p>
<p class="last">To disable destinations restrictions, you can set public_ips to False.</p>
</dd>
</dl>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">rich_rules</span><span class="p">(</span><span class="n">forward_port</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;port&#39;</span><span class="p">:</span> <span class="s1">&#39;12&#39;</span><span class="p">,</span> <span class="n">addr</span><span class="o">=</span><span class="s1">&#39;1.2.3.4&#39;</span><span class="p">},</span> <span class="n">port</span><span class="o">=</span><span class="s1">&#39;22&#39;</span><span class="p">)</span>
<span class="n">rich_rules</span><span class="p">(</span><span class="n">forward_port</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;port&#39;</span><span class="p">:</span> <span class="s1">&#39;12&#39;</span><span class="p">,</span> <span class="n">addr</span><span class="o">=</span><span class="s1">&#39;1.2.3.4&#39;</span><span class="p">},</span> <span class="n">port</span><span class="o">=</span><span class="s1">&#39;22&#39;</span><span class="p">},</span>
           <span class="n">destination</span><span class="o">=</span><span class="s1">&#39;x.x.x.x&#39;</span><span class="p">)</span>
<span class="n">rich_rules</span><span class="p">(</span><span class="n">masquerade</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">source</span><span class="o">=</span><span class="s1">&#39;x.x.x.x&#39;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s1">&#39;x.x.x.x&#39;</span><span class="p">)</span>
<span class="n">rich_rules</span><span class="p">(</span><span class="n">source</span><span class="o">=</span><span class="s1">&#39;address=&quot;1.2.3.4&quot;&#39;</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="s1">&#39;22&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;drop&#39;</span><span class="p">)</span>
<span class="n">rich_rules</span><span class="p">(</span><span class="n">destination</span><span class="o">=</span><span class="s1">&#39;address=&quot;1.2.3.4&quot;&#39;</span><span class="p">,</span>
           <span class="n">port</span><span class="o">=</span><span class="s1">&#39;22&#39;</span><span class="p">,</span>
           <span class="n">audit</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
           <span class="n">action</span><span class="o">=</span><span class="s1">&#39;drop&#39;</span><span class="p">)</span>
<span class="n">rich_rules</span><span class="p">(</span><span class="n">destination</span><span class="o">=</span><span class="s1">&#39;address=&quot;1.2.3.4&quot;&#39;</span><span class="p">,</span>
           <span class="n">port</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;port&#39;</span><span class="p">:</span> <span class="s1">&#39;22&#39;</span><span class="p">,</span> <span class="s1">&#39;protocol&#39;</span><span class="p">:</span> <span class="s1">&#39;tcp&#39;</span><span class="p">})</span>
<span class="n">rich_rules</span><span class="p">(</span><span class="n">destination</span><span class="o">=</span><span class="s1">&#39;address=&quot;1.2.3.4&quot;&#39;</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="s1">&#39;22&#39;</span><span class="p">,</span>
           <span class="n">audit</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;drop&#39;</span><span class="p">)</span>
</pre></div>
</div>
</dd></dl>

<dl class="function">
<dt id="mc_states.modules.mc_firewalld.search_aliased_interfaces">
<code class="descclassname">mc_states.modules.mc_firewalld.</code><code class="descname">search_aliased_interfaces</code><span class="sig-paren">(</span><em>data=None</em><span class="sig-paren">)</span><a class="headerlink" href="#mc_states.modules.mc_firewalld.search_aliased_interfaces" title="Permalink to this definition">¶</a></dt>
<dd><p>Add public interfaces as candidates for aliased zones
to support common IP Failover scenarii</p>
</dd></dl>

<dl class="function">
<dt id="mc_states.modules.mc_firewalld.settings">
<code class="descclassname">mc_states.modules.mc_firewalld.</code><code class="descname">settings</code><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="headerlink" href="#mc_states.modules.mc_firewalld.settings" title="Permalink to this definition">¶</a></dt>
<dd><p>firewalld settings</p>
<dl class="docutils">
<dt>makina-states.services.firewalld.enabled</dt>
<dd>set to true to activate firewalld</dd>
<dt>DESIGN</dt>
<dd>all services &amp; forwardport &amp; ports &amp; etc are setted
via rich rules to allow fine-graines selections of source
and destination variations.</dd>
</dl>
<p>GLOBAL SETTINGS</p>
<blockquote>
<div><dl class="docutils">
<dt>permissive_mode</dt>
<dd>force all traffic to be accepted</dd>
<dt>allow_local</dt>
<dd>force all traffic from rfc1918 to be accepted</dd>
<dt>public_interfaces</dt>
<dd>internet faced interfaces</dd>
<dt>internal_interfaces</dt>
<dd>interfaces wired to internal network with no much restriction</dd>
<dt>public_services</dt>
<dd>services to allow</dd>
<dt>restricted_services</dt>
<dd>services to block</dd>
<dt>&lt;XXX&gt;-direct</dt>
<dd>direct rules</dd>
<dt>&lt;XXX&gt;-passthrough</dt>
<dd>direct/passthrough rules (not implemented yet)</dd>
<dt>services</dt>
<dd>list of services to deine</dd>
<dt>zones</dt>
<dd>mapping of zones definitions</dd>
</dl>
</div></blockquote>
<p>PER ZONE SETTINGS</p>
<p>You can configure zone settings via via entries in the zone pillar</p>
<blockquote>
<div><dl class="docutils">
<dt>default_policy</dt>
<dd>enforce policy, attention in firewalld world, everything
is dropped if no match, so no need to force reject.
Its even harmful as it wont cut any further rich rules
to have a change to apply !</dd>
<dt>interfaces</dt>
<dd>interfaces to add to the zone</dd>
<dt>XXX-rules</dt>
<dd>rich rules</dd>
</dl>
</div></blockquote>
<p>For exmeple, to Add some rich rules in pillar to a zone, all
<code class="docutils literal"><span class="pre">makina-states.services.firewall.firewalld.zones.public.rules&lt;id&gt;</span></code>
are merged</p>
<div class="highlight-yaml"><div class="highlight"><pre><span></span>makina-states.services.firewall.firewalld.zones.public.rules-foo:
  {% for i in salt[&#39;mc_firewalld.rich_rules&#39;](
    port=22, action=&#39;drop&#39;
  )- {{i}} {% endfor %}
  {% for i in salt[&#39;mc_firewalld.rich_rules&#39;](
    forward_port={&#39;port&#39;: 1122, &#39;to_addr&#39;: &#39;1.2.3.4&#39;, &#39;to_port&#39;=22}
  )- {{i}} {% endfor %}
makina-states.services.firewall.firewalld.zones.public.rules-bar:
  - &quot;rule service name=&quot;ftp&quot; log limit value=&quot;1/m&quot; audit accept&quot;
  {% for i in salt[&#39;mc_firewalld.rich_rules&#39;](
    port=22, destinations=[&#39;127.0.0.1&#39;],  action=&#39;drop&#39;
  )- {{i}} {% endfor %}
  {% for i in salt[&#39;mc_firewalld.rich_rules&#39;](
      port=22, destinations=[&#39;not address=&quot;127.0.0.2&quot;&#39;],  action=&#39;drop&#39;
  )- {{i}} {% endfor %}
</pre></div>
</div>
<p>Whitelist some services:</p>
<blockquote>
<div><div class="highlight-yaml"><div class="highlight"><pre><span></span><span class="l l-Scalar l-Scalar-Plain">makina-states.services.firewall.firewalld.public_services-append</span><span class="p p-Indicator">:</span>
    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">smtp</span>
</pre></div>
</div>
</div></blockquote>
<p>Change whitelisted services:</p>
<blockquote>
<div><div class="highlight-yaml"><div class="highlight"><pre><span></span><span class="l l-Scalar l-Scalar-Plain">makina-states.services.firewall.firewalld.public_services</span><span class="p p-Indicator">:</span> <span class="p p-Indicator">[</span><span class="nv">http</span><span class="p p-Indicator">]</span>
</pre></div>
</div>
</div></blockquote>
<p>Define a new service:</p>
<blockquote>
<div><div class="highlight-yaml"><div class="highlight"><pre><span></span><span class="l l-Scalar l-Scalar-Plain">makina-states.services.firewall.firewalld.services.foo</span><span class="p p-Indicator">:</span>
    <span class="l l-Scalar l-Scalar-Plain">port</span><span class="p p-Indicator">:</span> <span class="p p-Indicator">[{</span><span class="nv">protocol</span><span class="p p-Indicator">:</span> <span class="nv">tcp</span><span class="p p-Indicator">,</span> <span class="nv">port</span><span class="p p-Indicator">:</span> <span class="nv">2222</span><span class="p p-Indicator">}]</span>
</pre></div>
</div>
</div></blockquote>
<dl class="docutils">
<dt>NOTE</dt>
<dd><dl class="first last docutils">
<dt><strong>DO NOT ACTIVATE MASQUERADING, IT IS TOO MUCH CATCHY</strong></dt>
<dd>PLEASE USE APPROPRIATE RESTRICTIVES RICH MASQUERADE RULES</dd>
</dl>
</dd>
</dl>
</dd></dl>

</div>


          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="mc_dbus.html" class="btn btn-neutral float-right" title="mc_dbus / dbus functions">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="mc_mvn.html" class="btn btn-neutral" title="mc_mvn / mvn registry"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2014 -&gt; 2017, Mathieu Le Marec Pasquet, Régis Leroy &amp; Makina Corpus folks.
    </p>
  </div>

  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
  
</footer>
        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../../',
            VERSION:'1.0',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true
        };
    </script>
      <script type="text/javascript" src="../../_static/jquery.js"></script>
      <script type="text/javascript" src="../../_static/underscore.js"></script>
      <script type="text/javascript" src="../../_static/doctools.js"></script>

  

  
  
    <script type="text/javascript" src="../../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>