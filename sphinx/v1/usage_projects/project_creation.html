

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Project management &mdash; Makina States 1.0 documentation</title>
  

  
  

  
  <link href='https://fonts.googleapis.com/css?family=Lato:400,700,400italic,700italic|Roboto+Slab:400,700|Inconsolata:400,700&subset=latin,cyrillic' rel='stylesheet' type='text/css'>

  
  
    

  

  
  
    <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  

  

  
    <link rel="top" title="Makina States 1.0 documentation" href="../../index.html"/>
        <link rel="up" title="Makina-States usage" href="../usage_index.html"/>
        <link rel="next" title="Projects list" href="project_list.html"/>
        <link rel="prev" title="Installation of a cluster based on mastersalt" href="../usage_mastersalt/install_mastersalt.html"/> 

  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/modernizr/2.6.2/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-nav-search">
        
          <a href="../../index.html" class="fa fa-home"> Makina States</a>
        
        
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
        
          
          
              <ul class="simple">
</ul>
<ul class="simple">
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../api/index.html">Custom states modules</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../api/modules/index.html">Execution modules</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api/states/index.html">States modules</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api/grains/index.html">makina-states grains modules</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api/api/index.html">Api  modules</a></li>
</ul>
</li>
</ul>
<ul class="current">
<li class="toctree-l1 current"><a class="reference internal" href="../index.html">Makina-states V1 documentation (OBSOLETE)</a><ul class="current">
<li class="toctree-l2 current"><a class="reference internal" href="../index.html#usage">Usage</a></li>
<li class="toctree-l2"><a class="reference internal" href="../index.html#reference">Reference</a></li>
</ul>
</li>
</ul>

          
        
      </div>
      &nbsp;
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../../index.html">Makina States</a>
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../../index.html">Docs</a> &raquo;</li>
      
          <li><a href="../index.html">Makina-states V1 documentation (OBSOLETE)</a> &raquo;</li>
      
          <li><a href="../usage_index.html">Makina-States usage</a> &raquo;</li>
      
    <li>Project management</li>
      <li class="wy-breadcrumbs-aside">
        
          <a href="../../_sources/v1/usage_projects/project_creation.txt" rel="nofollow"> View page source</a>
        
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document">
            
  <div class="section" id="project-management">
<h1><a class="toc-backref" href="#id2">Project management</a><a class="headerlink" href="#project-management" title="Permalink to this headline">¶</a></h1>
<div class="contents topic" id="contents">
<p class="topic-title first">Contents</p>
<ul class="simple">
<li><a class="reference internal" href="#project-management" id="id2">Project management</a><ul>
<li><a class="reference internal" href="#intro" id="id3">Intro</a></li>
<li><a class="reference internal" href="#specifications" id="id4">Specifications</a><ul>
<li><a class="reference internal" href="#initialization" id="id5">Initialization</a></li>
</ul>
</li>
<li><a class="reference internal" href="#deploying-two-ways-of-doing-things" id="id6">Deploying, two ways of doing things</a><ul>
<li><a class="reference internal" href="#mc-project-init-project-initialize-the-layout" id="id7">mc_project.init_project: initialize the layout</a></li>
<li><a class="reference internal" href="#mc-project-deploy-the-main-entry-point" id="id8">mc_project.deploy, the main entry point</a></li>
<li><a class="reference internal" href="#directly-on-the-remote-server-by-hand" id="id9">Directly on the remote server, by hand</a><ul>
<li><a class="reference internal" href="#variant-deploy-by-hand-on-a-vagrant-vm" id="id10">VARIANT: Deploy by hand, on a vagrant VM</a></li>
</ul>
</li>
<li><a class="reference internal" href="#deploy-with-git-instructions" id="id11">Deploy with git instructions</a><ul>
<li><a class="reference internal" href="#reminder" id="id12">Reminder</a></li>
<li><a class="reference internal" href="#deploy" id="id13">Deploy</a></li>
</ul>
</li>
<li><a class="reference internal" href="#sumup" id="id14">Sumup</a></li>
<li><a class="reference internal" href="#configuration-pillar-variables" id="id15">Configuration pillar &amp;  variables</a></li>
</ul>
</li>
<li><a class="reference internal" href="#what-s-happen-when-there-is-a-deploy" id="id16">What&#8217;s happen when there is a deploy ?</a></li>
<li><a class="reference internal" href="#filesystem-considerations" id="id17">Filesystem considerations</a></li>
<li><a class="reference internal" href="#saltstack-integration" id="id18">SaltStack integration</a></li>
<li><a class="reference internal" href="#related-topics" id="id19">Related topics</a></li>
</ul>
</li>
</ul>
</div>
<div class="section" id="intro">
<span id="project-creation"></span><h2><a class="toc-backref" href="#id3">Intro</a><a class="headerlink" href="#intro" title="Permalink to this headline">¶</a></h2>
<p>This page is the most important thing you ll have to read about makina-states as a <strong>developer consumer</strong>, take the time it needs and deserves.</p>
<p>Never be afraid to go read makina-states code, it will show you how to configure
and extend it. It is simple python and yaml.</p>
<p>See python exemples:</p>
<blockquote>
<div><ul class="simple">
<li><a class="reference external" href="https://github.com/makinacorpus/makina-states/tree/master/mc_states/modules">the modules</a> (<a class="reference external" href="https://docs.saltstack.com/en/latest/ref/modules/">saltstack doc about modules</a>)</li>
<li><a class="reference external" href="https://github.com/makinacorpus/makina-states/tree/master/mc_states/states">the states</a> (<a class="reference external" href="https://docs.saltstack.com/en/latest/ref/states/">saltstack doc about states</a>)</li>
<li><a class="reference external" href="https://github.com/makinacorpus/makina-states/tree/master/mc_states/runners">the runners</a> (<a class="reference external" href="https://docs.saltstack.com/en/latest/ref/runners/">saltstack doc about runners</a>)</li>
</ul>
</div></blockquote>
<dl class="docutils">
<dt>See formulaes exemples:</dt>
<dd><ul class="first last simple">
<li><a class="reference external" href="https://docs.saltstack.com/en/latest/ref/states/">saltstack doc about states formulaes</a></li>
<li><a class="reference external" href="https://docs.saltstack.com/en/latest/topics/tutorials/states_pt1.html">saltstack doc about states formulaes2</a></li>
<li><a class="reference external" href="https://github.com/makinacorpus/makina-states/tree/master/localsettings">the localsettings</a></li>
<li><a class="reference external" href="https://github.com/makinacorpus/makina-states/tree/master/services">the services</a></li>
</ul>
</dd>
</dl>
</div>
<div class="section" id="specifications">
<h2><a class="toc-backref" href="#id4">Specifications</a><a class="headerlink" href="#specifications" title="Permalink to this headline">¶</a></h2>
<p>See the original <a class="reference internal" href="project_corpus.html#project-corpus"><span>specification</span></a>, and specially the <a class="reference internal" href="project_corpus.html#project-spec-layout"><span>layout</span></a>, the <a class="reference internal" href="project_corpus.html#project-spec-proc-install"><span>install</span></a> procedure, and the <a class="reference internal" href="project_corpus.html#project-spec-proc-fixperms"><span>fixperms</span></a> procedure.</p>
<p>A good sumup of the spec is as follow, but please read it once...</p>
<blockquote>
<div><ul class="simple">
<li>There is a separate repo distributed along the project named <strong>pillar</strong> to
store configuration variables, passwords and so on.</li>
<li>Projects are deployed via instructions based on saltstack which are
contained into the <strong>.salt</strong> folder inside the codebase.</li>
</ul>
</div></blockquote>
<p>The deployment includes global phases in this order:</p>
<blockquote>
<div><ul class="simple">
<li>archive <code class="docutils literal"><span class="pre">archive.sls</span></code></li>
<li>sync code from remotes if there are remotes</li>
<li>sync/install custom salt modules (exec, states, etc) from the codebase if any</li>
<li>fixperms (<code class="docutils literal"><span class="pre">fixperms.sls</span></code>)</li>
<li>install  (<code class="docutils literal"><span class="pre">install.sls</span></code>)</li>
<li>fixperms</li>
<li>rollback (<code class="docutils literal"><span class="pre">rollback.sls</span></code>)if error</li>
</ul>
</div></blockquote>
<p>Some of those phases can be edited via the user, and some other not (install, &amp; sync steps).</p>
<p>That will explain that in your <strong>.salt</strong> folder, you have at least <code class="docutils literal"><span class="pre">install.sls</span></code>,
<code class="docutils literal"><span class="pre">fixperms.sls</span></code>, <code class="docutils literal"><span class="pre">rollback.sls</span></code>, and for old projects <code class="docutils literal"><span class="pre">notify.sls</span></code>.</p>
<p>All other sls found at <strong>toplevel</strong> which are not those ones are executed in
lexicographical order (alphanum) and the convention is to name them <code class="docutils literal"><span class="pre">\d\d\d_NAME.sls</span></code></p>
<p>The <code class="docutils literal"><span class="pre">PILLAR.sample</span></code> file contains default configuration variable for your
project and helps you to know what variable to override in your custom pillar.</p>
<div class="section" id="initialization">
<h3><a class="toc-backref" href="#id5">Initialization</a><a class="headerlink" href="#initialization" title="Permalink to this headline">¶</a></h3>
<ul>
<li><p class="first">a project in corpus / makina-states is a git repository checkout which contains the code
and a well known saltstack based procedure to deploy it
from end to end in the <strong>.salt</strong> folder.</p>
</li>
<li><p class="first">By default the project procedure is done via a <a class="reference external" href="http://docs.saltstack.com/en/latest/topics/tutorials/quickstart.html">masterless salt call</a>.</p>
</li>
<li><p class="first">The first thing to do is to create a <strong>nest</strong> from such a project, <strong>IF IT IS NOT ALREADY DONE</strong> (just ls /srv/projects to check):</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>salt-call --local mc_project.deploy &lt;project_name&gt; <span class="c1"># dont be long, dont use - &amp; _</span>
</pre></div>
</div>
</li>
<li><p class="first">This empty structure respects the aforementioned corpus reactor anatomy, and is just an useless helloword project which should look like:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span>/srv/projects/&lt;project_name&gt;
    |
    |- pillar/init.sls: override values in PILLAR.sample and define
    |                   any other arbitrary pillar DATA.
    |
    |- data/: anything which is persisted to disk must live here
    |         from drupal sites/default/files, python eggs, buildouts parts,
    |         gems cache, sqlite files, static files, docroots, etc.
    |
    |- project/ &lt;- a checkout or your project
    |   |-  .git
    |   |-  codebase
    |   |-  .salt
    |     |- _modules : custom salt python exec modules
    |     |- _states  : custom salt python states modules
    |     |- _runners : custom salt python runners modules
    |     |- _sdb     : custom salt python sdb modules
    |     |- _...
    |     |
    |     |- PILLAR.sample
    |     |- task_foo.sls
    |     |- 00_deploy.sls
    |
    [ If &quot;remote_less&quot; is False (default)
    |- git/project.git: bare git repos synchronnized (bi-directional)
    |                   with project/ used by git push style deployment
    |- git/pillar.git:  bare git repos synchronnized (bi-directional)
                        with pillar/ used by git push style deployment
</pre></div>
</div>
</li>
<li><p class="first">What you want to do is to replace the <code class="docutils literal"><span class="pre">project</span></code> folder by your repo.
This one contains your code, as asual, plus the <strong>.salt</strong> folder,</p>
</li>
<li><p class="first"><strong>WELL Understand</strong> what is :</p>
<blockquote>
<div><ul class="simple">
<li>a <a class="reference external" href="http://docs.saltstack.com/en/latest/topics/tutorials/starting_states.html#moving-beyond-a-single-sls">salt SLS</a> , it is the nerve of the war.</li>
<li>the <a class="reference external" href="http://docs.saltstack.com/en/latest/topics/tutorials/pillar.html">Pillar of salt</a>.</li>
</ul>
</div></blockquote>
</li>
<li><p class="first"><strong>be ware</strong>, on the production server the <code class="docutils literal"><span class="pre">.git/config</span></code> is linked with the
makina-states machinery and you cannot replace it blindly, you must use <a class="reference internal" href="#git-foo"><span>Deploy with git instructions</span></a> to
do it.</p>
</li>
<li><p class="first">Ensure to to have at least in your project git folder:</p>
<blockquote>
<div><ul class="simple">
<li><code class="docutils literal"><span class="pre">.salt/PILLAR.sample</span></code>: configuration default values to use in SLSes</li>
<li><code class="docutils literal"><span class="pre">.salt/archive.sls</span></code>: archive step</li>
<li><code class="docutils literal"><span class="pre">.salt/fixperms.sls</span></code>: fixperm step</li>
<li><code class="docutils literal"><span class="pre">.salt/rollback.sls</span></code>: rollback step</li>
</ul>
</div></blockquote>
</li>
<li><p class="first">You can then add as many SLSes as you want, and the ones directly in <strong>.salt</strong> will be executed in alphabetical order except the ones beginning with <strong>task_</strong> (task_foo.sls). Indeed the ones beginning with <strong>task_</strong> are different beasts and are intended to be either included by your other slses to factor code out or to be executed manually via the <code class="docutils literal"><span class="pre">mc_project.run_task</span></code> command.</p>
</li>
<li><p class="first">You can and must have a look for inspiration on <a class="reference internal" href="project_list.html#projects-project-list"><span>Projects list</span></a></p>
</li>
</ul>
</div>
</div>
<div class="section" id="deploying-two-ways-of-doing-things">
<h2><a class="toc-backref" href="#id6">Deploying, two ways of doing things</a><a class="headerlink" href="#deploying-two-ways-of-doing-things" title="Permalink to this headline">¶</a></h2>
<p>To build and deploy your project we provide two styles of doing style that should be appropriate for most use cases.</p>
<p>The common workflow is:</p>
<blockquote>
<div><ul class="simple">
<li>use <code class="docutils literal"><span class="pre">mc_project.init_project</span></code> to create the structure to host your project</li>
<li>use <code class="docutils literal"><span class="pre">mc_project.report</span></code> to verify things are in place</li>
<li>git push/or edit then push the pillar <code class="docutils literal"><span class="pre">/srv/projects/&lt;project&gt;/pillar</span></code> to configure the project</li>
<li>git push/or edit then push the code inside <code class="docutils literal"><span class="pre">/srv/projects/&lt;project&gt;/project</span></code></li>
<li>launch the deploy</li>
<li>Wash, Rince, Repeat</li>
</ul>
</div></blockquote>
<div class="section" id="mc-project-init-project-initialize-the-layout">
<h3><a class="toc-backref" href="#id7">mc_project.init_project: initialize the layout</a><a class="headerlink" href="#mc-project-init-project-initialize-the-layout" title="Permalink to this headline">¶</a></h3>
<p>The following command is the nerve of the war:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span>salt-call \
    --local -lall \
    mc_project.init_project $project [remote_less=false/true]
</pre></div>
</div>
<ul>
<li><p class="first"><code class="docutils literal"><span class="pre">--local</span> <span class="pre">-lall</span></code> instructs to run in masterless mode and extra verbosity</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">mc_project.init_project</span> <span class="pre">$project</span></code> instructs to create the layout of the name <code class="docutils literal"><span class="pre">$project</span></code> project living into <code class="docutils literal"><span class="pre">/srv/projects/$project/project</span></code></p>
</li>
<li><p class="first">(opt) <code class="docutils literal"><span class="pre">remote_less</span></code> instructs to deploy with or without the git repos that allow users to use (or not) a <strong>git push to prod to deploy</strong> workflow.</p>
<blockquote>
<div><ul class="simple">
<li>If <code class="docutils literal"><span class="pre">remote_less=true</span></code>, the git repos wont be created, and you wont be
able to push to git remotes to deploy your project (you ll have to do it
directly on the server, by the <a class="reference internal" href="#project-hand-procedure"><span>hand procedure</span></a>.</li>
<li>If <code class="docutils literal"><span class="pre">remote_less=false</span></code>, you ll also be able to use the
<a class="reference internal" href="#project-git-push-procedure"><span>push to prod feature</span></a>.</li>
</ul>
</div></blockquote>
</li>
</ul>
</div>
<div class="section" id="mc-project-deploy-the-main-entry-point">
<h3><a class="toc-backref" href="#id8">mc_project.deploy, the main entry point</a><a class="headerlink" href="#mc-project-deploy-the-main-entry-point" title="Permalink to this headline">¶</a></h3>
<p>The following command is the nerve of the war:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span>salt-call \
    --local -lall \
    mc_project.deploy $project\
     [only=step2[,step1]] \
     [only_steps=step2[,step1]]
</pre></div>
</div>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">--local</span> <span class="pre">-lall</span></code> instructs to run in masterless mode and extra verbosity</li>
<li><code class="docutils literal"><span class="pre">mc_project.deploy</span> <span class="pre">$project</span></code> instructs to deploy the name <code class="docutils literal"><span class="pre">$project</span></code> project living into <code class="docutils literal"><span class="pre">/srv/projects/$project/project</span></code></li>
<li>(opt) <code class="docutils literal"><span class="pre">only</span></code> instructs to execute only the named global phases, and when deploying directly onto a machine, you will certainly have to use <code class="docutils literal"><span class="pre">only=install,fixperms,sync_modules</span></code>
to avoid the archive/sync/rollback steps.</li>
<li>(opt) <code class="docutils literal"><span class="pre">only_steps</span></code> instruct to execute only a specific or multiple specific sls from the <strong>.salt</strong> folder during the <strong>install</strong> phase.</li>
</ul>
</div>
<div class="section" id="directly-on-the-remote-server-by-hand">
<span id="project-hand-procedure"></span><h3><a class="toc-backref" href="#id9">Directly on the remote server, by hand</a><a class="headerlink" href="#directly-on-the-remote-server-by-hand" title="Permalink to this headline">¶</a></h3>
<p>Either directly from the deployment host as root:</p>
<p>Initialise the layout (only the first time)</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>ssh root@remoteserver
<span class="nb">export</span> <span class="nv">project</span><span class="o">=</span><span class="s2">&quot;foo&quot;</span>
salt-call --local -ldebug mc_project.init_project <span class="nv">$project</span>
</pre></div>
</div>
<p>Edit the pillar</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>ssh root@remoteserver
<span class="nb">export</span> <span class="nv">project</span><span class="o">=</span><span class="s2">&quot;foo&quot;</span>
<span class="nb">cd</span> /srv/projects/<span class="nv">$project</span>
<span class="c1"># maybe you want to edit before pillar deploy</span>
$ÊDITOR pillar/init.sls
<span class="nb">cd</span> pillar<span class="p">;</span>git commit -m foo<span class="p">;</span>git push<span class="p">;</span><span class="nb">cd</span> ..
</pre></div>
</div>
<p>Update the project code base from git</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>ssh root@remoteserver
<span class="nb">export</span> <span class="nv">project</span><span class="o">=</span><span class="s2">&quot;foo&quot;</span>
<span class="nb">cd</span> /srv/projects/<span class="nv">$project</span>/project
<span class="c1"># if not already done, add your project repo remote</span>
git remote add g https://github.com/o/myproject.git
<span class="c1"># in any cases, update your code</span>
git fetch --all
git reset --hard remotes/g/&lt;the branch to deploy&gt;
git push --force origin HEAD:master
</pre></div>
</div>
<p>Launch deploy</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>ssh root@remoteserver
<span class="c1"># launch the deployment</span>
<span class="nb">export</span> <span class="nv">project</span><span class="o">=</span><span class="s2">&quot;foo&quot;</span>
salt-call --local -ldebug <span class="se">\</span>
    mc_project.deploy <span class="nv">$project</span> <span class="se">\</span>
    <span class="nv">only</span><span class="o">=</span>install,fixperms,sync_modules
<span class="c1"># or to deploy only a specific sls</span>
salt-call --local -ldebug <span class="se">\</span>
    mc_project.deploy <span class="nv">$project</span> <span class="se">\</span>
    <span class="nv">only</span><span class="o">=</span>install,fixperms,sync_modules <span class="nv">only_steps</span><span class="o">=</span>000_foo.sls
git push o HEAD:&lt;master&gt; <span class="c1"># replace master by the branch you want to push</span>
                         <span class="c1"># back onto your forge</span>
</pre></div>
</div>
<div class="section" id="variant-deploy-by-hand-on-a-vagrant-vm">
<h4><a class="toc-backref" href="#id10">VARIANT: Deploy by hand, on a vagrant VM</a><a class="headerlink" href="#variant-deploy-by-hand-on-a-vagrant-vm" title="Permalink to this headline">¶</a></h4>
<p>We generally setup environments based on <a class="reference external" href="https://github.com/makinacorpus/vms">makina-states/vms</a> that we share amongst our developers.</p>
<p>In development, our best practises are not to pull from our private git repositories
directly from inside the VM.</p>
<p>The HOST on which the virtualbox is running, is on the contrary controlled
by the developer and it&#8217;s more safe to pull/push the code from here.</p>
<p>To sum up, any <strong>git push/pull</strong> operation has to be done <strong>from the localhost</strong>
and not the vm.</p>
<p>In other words, the HOST can access any of the VM files with the help of a shared <strong>sshfs</strong> mountpoint <code class="docutils literal"><span class="pre">./VM</span></code>.
And the HOST can also access the outside repositories.
So the host in the interface that will push code inside the VM.</p>
<p>This setup involves using the <code class="docutils literal"><span class="pre">remote_less</span></code> feature of <code class="docutils literal"><span class="pre">mc_project</span></code> where
we do not deploy via a <code class="docutils literal"><span class="pre">git</span> <span class="pre">push</span></code> nor use <code class="docutils literal"><span class="pre">archive/rollback</span></code> mechanims.</p>
<p>Initialise/launch a <a class="reference external" href="https://github.com/makinacorpus/vms">makina-states/vms</a> box (this will take some time, specially
the first time)</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>git clone https://github.com/makinacorpus/vms
<span class="nb">cd</span> vms
./manage.sh init
</pre></div>
</div>
<p>Open one console connected to the VM as <strong>root</strong></p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>./manage.sh ssh
sudo su <span class="c1"># (default password: vagrant)</span>
</pre></div>
</div>
<p>Initialise the layout (only the first time)</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>ssh root@remoteserver
<span class="nb">export</span> <span class="nv">project</span><span class="o">=</span><span class="s2">&quot;foo&quot;</span>
salt-call --local -ldebug mc_project.init_project <span class="nv">$project</span> <span class="nv">remote_less</span><span class="o">=</span><span class="nb">true</span>
</pre></div>
</div>
<p>Edit the pillar</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="nb">cd</span> /srv/projects/<span class="nv">$project</span>/pillar
<span class="nv">$EDITOR</span> init.sls
git commit -am up
</pre></div>
</div>
<p>Open a second shell, on your local machine ( <strong>not on the VM</strong> )
where you ll update the project code base from git.</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="nb">export</span> <span class="nv">project</span><span class="o">=</span><span class="s2">&quot;foo&quot;</span>
<span class="nb">cd</span> vms/VM/srv/projects/<span class="nv">$project</span>/project
<span class="c1"># if not already done, add your project repo remote</span>
git remote add o https://github.com/o/myproject.git
<span class="c1"># in any cases, update your code</span>
git fetch --all
git reset --hard remotes/o/&lt;the branch to deploy&gt;
</pre></div>
</div>
<p>On the former shell ssh-connected to the vagrant box, launch deploy</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>salt-call --local -ldebug mc_project.deploy <span class="nv">$project</span> <span class="nv">only</span><span class="o">=</span>install,fixperms,sync_modules
<span class="c1"># or to deploy only a specific sls</span>
salt-call --local -ldebug <span class="se">\</span>
    mc_project.deploy <span class="nv">$project</span> <span class="se">\</span>
    <span class="nv">only</span><span class="o">=</span>install,fixperms,sync_modules <span class="nv">only_steps</span><span class="o">=</span>000_foo.sls
</pre></div>
</div>
<p>When you want to commit your changes, return to the second shell, on your local
machine</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="nb">export</span> <span class="nv">project</span><span class="o">=</span><span class="s2">&quot;foo&quot;</span>
<span class="nb">cd</span> vms/VM/srv/<span class="nv">$project</span>/project
git push o HEAD:&lt;master&gt; <span class="c1"># replace master by the branch you want to push</span>
                         <span class="c1"># back onto your forge</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="deploy-with-git-instructions">
<span id="git-foo"></span><h3><a class="toc-backref" href="#id11">Deploy with git instructions</a><a class="headerlink" href="#deploy-with-git-instructions" title="Permalink to this headline">¶</a></h3>
<div class="section" id="reminder">
<h4><a class="toc-backref" href="#id12">Reminder</a><a class="headerlink" href="#reminder" title="Permalink to this headline">¶</a></h4>
<ul class="simple">
<li><strong>WARNING</strong>: you can use it only if you provisionned your project with
attached remotes (the default)</li>
<li>Remember use the remotes inside <code class="docutils literal"><span class="pre">/srv/projects/&lt;project&gt;/git</span></code> and not directly the
working copies</li>
<li>If you push on the pillar, it does not trigger a deploy</li>
<li>If you push on the project,  it triggers the full deploy procedure
including archive/sync/rollback.</li>
<li>To get useful push informations, on the remote server to deploy to, just do</li>
</ul>
<div class="highlight-bash"><div class="highlight"><pre><span></span>salt-call --local -lall mc_project.report
</pre></div>
</div>
</div>
<div class="section" id="deploy">
<span id="project-git-push-procedure"></span><h4><a class="toc-backref" href="#id13">Deploy</a><a class="headerlink" href="#deploy" title="Permalink to this headline">¶</a></h4>
<p>The following lines edit the pillar, and push it, this does not trigger a deploy</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="nb">cd</span> <span class="nv">$WORKSPACE</span>/myproject
git clone host:/srv/projects/project/git/pillar.git
<span class="nv">$EDITOR</span> pillar/init.sls
<span class="nb">cd</span> pillar<span class="p">;</span>git commit -am up<span class="p">;</span>git push<span class="p">;</span><span class="nb">cd</span> ..
</pre></div>
</div>
<p>The following lines prepare a clone of your project codebase to be able to be
deployed onto production or staging servers</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="nb">cd</span> <span class="nv">$WORKSPACE</span>/myproject
git clone git@github.com/makinacorpus/myawsomeproject.git
git remote add prod /srv/projects/project/git/project.git
git fetch --all
</pre></div>
</div>
<p>To trigger a remote deployment, now you can do:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>git push <span class="o">[</span>--force<span class="o">]</span> prod &lt;mybranch&gt;:master
eg: git push <span class="o">[</span>--force<span class="o">]</span> prod &lt;mybranch&gt;:master
eg: git push <span class="o">[</span>--force<span class="o">]</span> prod awsome_feature:master
</pre></div>
</div>
<ul class="simple">
<li><dl class="first docutils">
<dt><strong>REMINDER</strong>:</dt>
<dd><ul class="first last">
<li>DONT MESS WITH THE <strong>ORIGIN</strong> REMOTE when your are connected to your
server in any of the <code class="docutils literal"><span class="pre">pillar</span></code> or <code class="docutils literal"><span class="pre">project</span></code> directory..</li>
<li>The <code class="docutils literal"><span class="pre">&lt;branchname&gt;:master</span></code> is really important as everything in the production
git repositories is wired on the <code class="docutils literal"><span class="pre">master</span></code> branch.
You can push any branch you want from your original
repository, but in production, there is only <strong>master</strong>.</li>
</ul>
</dd>
</dl>
</li>
</ul>
</div>
</div>
<div class="section" id="sumup">
<h3><a class="toc-backref" href="#id14">Sumup</a><a class="headerlink" href="#sumup" title="Permalink to this headline">¶</a></h3>
<p>To sum all that up, when beginning project you will:</p>
<ul>
<li><p class="first">Initialize if not done a project structure with <code class="docutils literal"><span class="pre">salt-call</span> <span class="pre">--local</span> <span class="pre">mc_project.init_project</span> <span class="pre">project</span></code></p>
</li>
<li><p class="first">If you do not want git remotes, you can alternativly use <code class="docutils literal"><span class="pre">salt-call</span> <span class="pre">--local</span> <span class="pre">mc_project.init_project</span> <span class="pre">project</span> <span class="pre">remote_less=true</span></code></p>
</li>
<li><p class="first">add a <strong>.salt</strong> folder alongside your project codebase (in it&#8217;s git repo).</p>
</li>
<li><p class="first">deploy it, either by:</p>
<blockquote>
<div><ul class="simple">
<li>git push your <strong>pillar</strong> files to <code class="docutils literal"><span class="pre">host:/srv/projects/&lt;project&gt;/git/pillar.git</span></code></li>
<li>git push your <strong>project code</strong> to <code class="docutils literal"><span class="pre">host:/srv/projects/&lt;project&gt;/git/project.git</span></code>
(this last push triggers a deploy on the remote server)</li>
<li>Your can use <code class="docutils literal"><span class="pre">--force</span></code> as the deploy system only await the <code class="docutils literal"><span class="pre">.salt</span></code> folder.
As long as the folder is present of the working copy you are sending, the
deploy system will be happy.</li>
</ul>
</div></blockquote>
</li>
<li><p class="first">or connected to the remote host to deploy onto</p>
<blockquote>
<div><ul class="simple">
<li>edit/commit/push in <code class="docutils literal"><span class="pre">host:/srv/projects/&lt;project&gt;/pillar</span></code></li>
<li>edit/commit/push/push to force in <code class="docutils literal"><span class="pre">host:/srv/projects/&lt;project&gt;</span></code></li>
<li>Launch the <code class="docutils literal"><span class="pre">salt-call</span> <span class="pre">--local</span> <span class="pre">mc_project.deploy</span> <span class="pre">&lt;name&gt;</span> <span class="pre">only=install,fixperms,sync_modules</span></code> dance</li>
</ul>
</div></blockquote>
</li>
<li><p class="first">Wash, Rince, Repeat</p>
</li>
</ul>
</div>
<div class="section" id="configuration-pillar-variables">
<h3><a class="toc-backref" href="#id15">Configuration pillar &amp;  variables</a><a class="headerlink" href="#configuration-pillar-variables" title="Permalink to this headline">¶</a></h3>
<p>We provide in <strong>mc_project</strong> a powerfull mecanism to define default variables used in your deployments.
hat you can safely override in the salt pillar files.
This means that you can set some default values for, eg a domain name or a password, and input the production values that you won&#8217;t commit along side your project codebase.</p>
<ul>
<li><p class="first">Default values have to be stored inside the <strong>PILLAR.sample</strong> file.</p>
</li>
<li><p class="first">Some of those variables, the one at the first level are mostly read only and setup by makina-states itself.
The most important are:</p>
<blockquote>
<div><ul class="simple">
<li><code class="docutils literal"><span class="pre">name</span></code>: project name</li>
<li><code class="docutils literal"><span class="pre">user</span></code>: the system user of your project</li>
<li><code class="docutils literal"><span class="pre">group</span></code>: the system group of your project</li>
<li><code class="docutils literal"><span class="pre">data</span></code>: top level free variables mapping</li>
<li><code class="docutils literal"><span class="pre">project_root</span></code>: project root absolute path</li>
<li><code class="docutils literal"><span class="pre">data_root</span></code>: persistent folder absolute path</li>
<li><code class="docutils literal"><span class="pre">default_env</span></code>: environment (staging/prod/dev)</li>
<li><code class="docutils literal"><span class="pre">pillar_root</span></code>: absolute path to the pillar</li>
<li><code class="docutils literal"><span class="pre">fqdn</span></code>: machine FQDN</li>
</ul>
</div></blockquote>
</li>
<li><p class="first">The only variables that you can edit at the first level are:</p>
<blockquote>
<div><ul class="simple">
<li><strong>remote_less</strong>: is this project using git remotes for triggering deployments</li>
<li><strong>default_env</strong>: environement (valid values are staging/dev/prod)</li>
<li><strong>env_defaults</strong>: indexed by <strong>env</strong> dict that overloads data (pillar will still have the priority)</li>
<li><strong>os_defaults</strong>: indexed by <strong>os</strong> dict that overloads data (pillar will still have the priority)</li>
</ul>
</div></blockquote>
</li>
<li><p class="first">The other variables, members of the <strong>data</strong> sub entry are free for you to add/edit.</p>
</li>
<li><p class="first">Any thing in the pillar <code class="docutils literal"><span class="pre">pillar/init.sls</span></code> overloads what is in <code class="docutils literal"><span class="pre">project/.salt/PILLAR.sample</span></code>.</p>
</li>
</ul>
<p>You can get and consult the result of the configuration assemblage like this:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span>salt-call --local -ldebug mc_project.get_configuration &lt;project_name&gt;
</pre></div>
</div>
<ul>
<li><p class="first">Remember that projects have a name, and the pillar key to configure and
overload your project configuration is based on this key.</p>
<p>If your project is name <strong>foo</strong>, you ll have to use <strong>makina-projects.foo</strong> in
place of <strong>makina-projects.example</strong>.</p>
</li>
</ul>
<p>Example</p>
<p>in <code class="docutils literal"><span class="pre">project/.salt/PILLAR.sample</span></code>, you have:</p>
<div class="highlight-yaml"><div class="highlight"><pre><span></span><span class="l l-Scalar l-Scalar-Plain">makina-projects.projectname</span><span class="p p-Indicator">:</span>
  <span class="l l-Scalar l-Scalar-Plain">data</span><span class="p p-Indicator">:</span>
    <span class="l l-Scalar l-Scalar-Plain">start_cmd</span><span class="p p-Indicator">:</span> <span class="s">&#39;myprog&#39;</span>
</pre></div>
</div>
<p>in <code class="docutils literal"><span class="pre">pillar/init.sls</span></code>, you have:</p>
<div class="highlight-yaml"><div class="highlight"><pre><span></span><span class="l l-Scalar l-Scalar-Plain">makina-projects.foo</span><span class="p p-Indicator">:</span>
   <span class="l l-Scalar l-Scalar-Plain">data</span><span class="p p-Indicator">:</span>
     <span class="l l-Scalar l-Scalar-Plain">start_cmd</span><span class="p p-Indicator">:</span> <span class="s">&#39;myprog2&#39;</span>
</pre></div>
</div>
<ul class="simple">
<li>In your states files, you can access the configuration via the magic
<code class="docutils literal"><span class="pre">opts.ms_project</span></code> variable.</li>
<li>In your modules or file templates, you can access the configuration via <code class="docutils literal"><span class="pre">salt['mc_project.get_configuration'(name)</span></code>.</li>
<li>A tip for loading the configuration from a template is doing something like that:</li>
</ul>
<div class="highlight-yaml"><div class="highlight"><pre><span></span># project/.salt/00_deploy.sls
{% set cfg = opts.ms_project %}
toto:
  file.managed:
      - name: &quot;source://makina-projects/{{cfg.name}}/files/etc/foo&quot;
      - target: /etc/foo
      - user {{cfg.user}}
      - group {{cfg.user}}
      - defaults:
          project: {{cfg.name}}

# project/.salt/files/etc/foo
{% set cfg = opts.ms_project %}
My Super Template of {{cfg.name}} will run {{cfg.data.start_cmd}}
</pre></div>
</div>
</div>
</div>
<div class="section" id="what-s-happen-when-there-is-a-deploy">
<h2><a class="toc-backref" href="#id16">What&#8217;s happen when there is a deploy ?</a><a class="headerlink" href="#what-s-happen-when-there-is-a-deploy" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li>When you do a git push, you have the full procedure, see <a class="reference internal" href="project_corpus.html#project-spec-deploy-proc"><span>spec doc</span></a></li>
<li>When you use <code class="docutils literal"><span class="pre">only=install,fixperms,sync_modules</span></code> it only do some the <a class="reference internal" href="project_corpus.html#project-spec-proc-install"><span>install</span></a> &amp; <a class="reference internal" href="project_corpus.html#project-spec-proc-fixperms"><span>fixperms</span></a> procedures.</li>
</ul>
</div>
<div class="section" id="filesystem-considerations">
<h2><a class="toc-backref" href="#id17">Filesystem considerations</a><a class="headerlink" href="#filesystem-considerations" title="Permalink to this headline">¶</a></h2>
<p>We use <a class="reference external" href="http://en.wikipedia.org/wiki/Access_control_list#Filesystem_ACLs">POSIX Acls</a> in
various places on your project folders.
At first, it feels a bit complicated, but it will enable you to smoothlessly edit your files or run
your programs with appropriate users without loosing security.</p>
</div>
<div class="section" id="saltstack-integration">
<h2><a class="toc-backref" href="#id18">SaltStack integration</a><a class="headerlink" href="#saltstack-integration" title="Permalink to this headline">¶</a></h2>
<p>As you know in makina-states, there are 2 concurrent salt installs, one for <strong>salt</strong>, the one that you use,
and one for <strong>mastersalt</strong> for the devil ops.
In makina-states, we use by default:</p>
<ul class="simple">
<li>a virtualenv inside <code class="docutils literal"><span class="pre">/salt-venv/salt</span></code></li>
<li><a class="reference external" href="https://github.com/makina-corpus/salt.git">salt from a fork</a> installed inside <code class="docutils literal"><span class="pre">/salt-venv/salt/src/salt</span></code></li>
<li>the salt file root resides, as usual, in <code class="docutils literal"><span class="pre">/srv/salt</span></code></li>
<li>the salt pillar root resides, as usual, in <code class="docutils literal"><span class="pre">/srv/pillar</span></code></li>
<li>the salt configuration root resides, as usual, in <code class="docutils literal"><span class="pre">/etc/salt</span></code></li>
</ul>
<p>As you see, the project layout seems not integration on those following folders, but in fact, the project
initialisation routines made symlinks to integrate it which look like:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span>/srv/salt/makina-projects/&lt;project_name&gt;&gt;  -&gt; /srv/projects/&lt;project_name&gt;/project§/.salt
/srv/pillar/makina-projects/&lt;project_name&gt; -&gt; /srv/projects/&lt;project_name&gt;/pillar
</pre></div>
</div>
<ul class="simple">
<li>The pillar is auto included in the <strong>pillar top</strong> (<code class="docutils literal"><span class="pre">/srv/pîllar/top.sls</span></code>).</li>
<li>The project salt files are not and <strong>must not</strong> be included in the salt <strong>top</strong> for further highstates unless
you know what you are doing.</li>
</ul>
<p>You can unlink your project from salt with:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span>salt-call --local -ldebug mc_project.unlink &lt;project_name&gt;
</pre></div>
</div>
<p>You can link project from salt with:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span>salt-call --local -ldebug mc_project.link &lt;project_name&gt;
</pre></div>
</div>
</div>
<div class="section" id="related-topics">
<h2><a class="toc-backref" href="#id19">Related topics</a><a class="headerlink" href="#related-topics" title="Permalink to this headline">¶</a></h2>
<p>You can refer to <a class="reference internal" href="../../api/modules/mc_project_2.html#module-mc-project-2"><span>mc_project_2 / project settings regitry APIV2</span></a></p>
</div>
</div>


          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="project_list.html" class="btn btn-neutral float-right" title="Projects list">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="../usage_mastersalt/install_mastersalt.html" class="btn btn-neutral" title="Installation of a cluster based on mastersalt"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2014 -&gt; 2017, Mathieu Le Marec Pasquet, Régis Leroy &amp; Makina Corpus folks.
    </p>
  </div>

  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
  
</footer>
        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../../',
            VERSION:'1.0',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true
        };
    </script>
      <script type="text/javascript" src="../../_static/jquery.js"></script>
      <script type="text/javascript" src="../../_static/underscore.js"></script>
      <script type="text/javascript" src="../../_static/doctools.js"></script>

  

  
  
    <script type="text/javascript" src="../../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>