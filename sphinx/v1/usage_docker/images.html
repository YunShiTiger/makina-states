

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Makina-States based docker Images &mdash; Makina States 1.0 documentation</title>
  

  
  

  
  <link href='https://fonts.googleapis.com/css?family=Lato:400,700,400italic,700italic|Roboto+Slab:400,700|Inconsolata:400,700&subset=latin,cyrillic' rel='stylesheet' type='text/css'>

  
  
    

  

  
  
    <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  

  

  
    <link rel="top" title="Makina States 1.0 documentation" href="../../index.html"/>
        <link rel="up" title="Use makina-states in docker" href="index.html"/>
        <link rel="next" title="Mastersalt documentation" href="../usage_mastersalt/index.html"/>
        <link rel="prev" title="Install a makina-states docker environement" href="install.html"/> 

  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/modernizr/2.6.2/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-nav-search">
        
          <a href="../../index.html" class="fa fa-home"> Makina States</a>
        
        
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
        
          
          
              <ul class="simple">
</ul>
<ul class="simple">
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../api/index.html">Custom states modules</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../api/modules/index.html">Execution modules</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api/states/index.html">States modules</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api/grains/index.html">makina-states grains modules</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api/api/index.html">Api  modules</a></li>
</ul>
</li>
</ul>
<ul class="current">
<li class="toctree-l1 current"><a class="reference internal" href="../index.html">Makina-states V1 documentation (OBSOLETE)</a><ul class="current">
<li class="toctree-l2 current"><a class="reference internal" href="../index.html#usage">Usage</a></li>
<li class="toctree-l2"><a class="reference internal" href="../index.html#reference">Reference</a></li>
</ul>
</li>
</ul>

          
        
      </div>
      &nbsp;
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../../index.html">Makina States</a>
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../../index.html">Docs</a> &raquo;</li>
      
          <li><a href="../index.html">Makina-states V1 documentation (OBSOLETE)</a> &raquo;</li>
      
          <li><a href="../usage_index.html">Makina-States usage</a> &raquo;</li>
      
          <li><a href="index.html">Use makina-states in docker</a> &raquo;</li>
      
    <li>Makina-States based docker Images</li>
      <li class="wy-breadcrumbs-aside">
        
          <a href="../../_sources/v1/usage_docker/images.txt" rel="nofollow"> View page source</a>
        
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document">
            
  <div class="section" id="makina-states-based-docker-images">
<h1><a class="toc-backref" href="#id6">Makina-States based docker Images</a><a class="headerlink" href="#makina-states-based-docker-images" title="Permalink to this headline">¶</a></h1>
<div class="contents topic" id="contents">
<p class="topic-title first">Contents</p>
<ul class="simple">
<li><a class="reference internal" href="#makina-states-based-docker-images" id="id6">Makina-States based docker Images</a><ul>
<li><a class="reference internal" href="#rules" id="id7">Rules</a><ul>
<li><a class="reference internal" href="#run-time" id="id8">Run time</a></li>
<li><a class="reference internal" href="#build-time" id="id9">Build time</a></li>
</ul>
</li>
<li><a class="reference internal" href="#layout-inside-the-image" id="id10">layout inside the Image</a></li>
<li><a class="reference internal" href="#initialise-your-dev-environment" id="id11">Initialise your dev environment</a><ul>
<li><a class="reference internal" href="#download-and-initialize-the-layout" id="id12">Download and initialize the layout</a></li>
<li><a class="reference internal" href="#optionnal-generate-a-a-certificate-with-a-custom-authority-for-testing-purposes" id="id13">OPTIONNAL: Generate a a certificate with a custom authority for testing purposes</a></li>
<li><a class="reference internal" href="#register-the-certificate-to-the-host-openssl-configuration" id="id14">Register the certificate to the host openssl configuration</a></li>
<li><a class="reference internal" href="#configure-the-image-via-the-salt-pillar" id="id15">Configure the image via the salt PILLAR</a></li>
</ul>
</li>
<li><a class="reference internal" href="#build-run" id="id16">Build &amp; Run</a><ul>
<li><a class="reference internal" href="#dns-configuration" id="id17">DNS configuration</a></li>
</ul>
</li>
<li><a class="reference internal" href="#list-of-example-images" id="id18">List of example images</a></li>
</ul>
</li>
</ul>
</div>
<div class="section" id="rules">
<h2><a class="toc-backref" href="#id7">Rules</a><a class="headerlink" href="#rules" title="Permalink to this headline">¶</a></h2>
<ul>
<li><p class="first">Docker images share a common layout, and inherit from the <code class="docutils literal"><span class="pre">makina-states</span></code> base images from docker-hub.</p>
</li>
<li><p class="first">Applications are deployed into those containers via <a class="reference internal" href="../usage_projects/project_creation.html#project-creation"><span>mc_project</span></a>.</p>
</li>
<li><p class="first">Those images use <strong>mc_project</strong> in <code class="docutils literal"><span class="pre">remote_less</span></code> mode and should not rely on a full
system running, we are in a docker. For long living processes, use circus.</p>
</li>
<li><p class="first">Runtime include an <code class="docutils literal"><span class="pre">initial</span> <span class="pre">pre-re-configure</span> <span class="pre">step</span></code> before launching the app
and the entry point lives into <code class="docutils literal"><span class="pre">$project_root/bin/launch.sh</span></code></p>
<blockquote>
<div><ul class="simple">
<li>Ideally, there is a <code class="docutils literal"><span class="pre">mc_launcher.py</span></code> saltstack module to orchestrate the whole reconfigure step.</li>
</ul>
</div></blockquote>
</li>
<li><p class="first">Images include at least 2 mountpoints for the <code class="docutils literal"><span class="pre">logs</span></code> and the <code class="docutils literal"><span class="pre">data</span></code> folders.</p>
</li>
</ul>
<div class="section" id="run-time">
<h3><a class="toc-backref" href="#id8">Run time</a><a class="headerlink" href="#run-time" title="Permalink to this headline">¶</a></h3>
<p>The app is launched an managed via a <code class="docutils literal"><span class="pre">bin/launch.sh</span></code> (<a class="reference external" href="https://github.com/makinacorpus/corpus-dockerregistry/blob/master/bin/launch.sh">Example</a>) script, which should ideally:</p>
<blockquote>
<div><ul>
<li><p class="first">Replace the default pillar by the <strong>configuration/pillar.sls</strong> if it
existsa. This is the only thing we need to do before launching a salt
module script that does the rest.</p>
</li>
<li><p class="first">Execute a salt <strong>mc_launcher.py</strong> (<a class="reference external" href="https://github.com/makinacorpus/corpus-dockerregistry/blob/master/.salt/_modules/mc_launcher.py">Example</a>) module which runs our app after maybe
having reconfigured it.</p>
<blockquote>
<div><ul>
<li><p class="first">allow inbound ssh connections for allowed keys</p>
</li>
<li><p class="first">reconfigure (ideally by exec&#8217;ing a subset of the sls in <strong>.salt</strong>)
the container to serve the app (eg: update domain to server,
ip of the database, registration to autodiscovery service)</p>
</li>
<li><p class="first">spawn a circus daemon at the end of the configuration.</p>
</li>
<li><p class="first">The module should have at least implements this interface:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">sshconfig</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">PROJECT</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;code to allow ssh_keys to connect&#39;&#39;&#39;</span>
    <span class="k">pass</span>
<span class="k">def</span> <span class="nf">reconfigure</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">PROJECT</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;code to reconfigure the app to serve requests</span>
<span class="sd">      in this specific context&#39;&#39;&#39;</span>
    <span class="k">pass</span>
<span class="k">def</span> <span class="nf">launch</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">PROJECT</span><span class="p">,</span> <span class="n">ssh_config</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">re_configure</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">ssh_config</span><span class="p">:</span>
        <span class="n">ssh_config</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">re_configure</span>
        <span class="n">re_configure</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">)</span>
    <span class="c1"># code to launch the app in foreground</span>
</pre></div>
</div>
</li>
</ul>
</div></blockquote>
</li>
</ul>
</div></blockquote>
<ul class="simple">
<li>Indeed, the app is lightly reconfigured via salt and may be given an
overriden pillar file via a filesystem volume to help to reconfigure it.
<strong>Think to rename the pillar configuration key along with the name of your project</strong>
See <span class="xref std std-ref">mc_project configuration pillar file</span></li>
<li>Volumes and files that need to be prepolulated should be filled by the
launcher if and only if it is not already data placed into them.</li>
<li>A Control-C or quit signal must inhibit any launched process more or less
gracefully</li>
</ul>
</div>
<div class="section" id="build-time">
<h3><a class="toc-backref" href="#id9">Build time</a><a class="headerlink" href="#build-time" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li>We configure the image through a regular <a class="reference internal" href="../usage_projects/project_creation.html#project-creation"><span>mc_project</span></a> based
saltstack project.</li>
<li>All the processes inside the container must be managed if possible via circus</li>
<li>POSIX Acls are now to be avoided at all cost to avoid export/import problems as tar
is used to exchange images, the extended attributes are lost in the middle</li>
</ul>
</div>
</div>
<div class="section" id="layout-inside-the-image">
<h2><a class="toc-backref" href="#id10">layout inside the Image</a><a class="headerlink" href="#layout-inside-the-image" title="Permalink to this headline">¶</a></h2>
<p>This is of course an example but it reflects what we need to respect:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span>/srv/salt/custom.sls      &lt;- custom pillar
/srv/projects/&lt;project&gt;
   |
   |- project/ &lt;- application code
   |     |- Dockerfile    &lt;- Each app needs to have a basic Dockerfile
   |     |- bin/launch.sh &lt;- launcher that:
   |     |                   - copy $data/configuration/pillar.sls -&gt; $pillar/init.sls
   |     |                   - reconfigure (via salt) the app
   |     |                   - launch the app in foreground
   |     |- .salt         &lt;- deployment and reconfigure code (mc_project based)
   |     |- .salt/100_dirs_and_prerequisites.sls
   |     |- .salt/200_reconfigure.sls
   |     |- .salt/300_nginx.sls
   |     |- .salt/400_circus.sls
   |     |- .salt/_modules/mc_launcher.py
   |                code that is used to reconfigure the image
   |                at launch time (via launch.sh)
   |
   |- pillar/  &lt;- salt extra pillar that overrides PILLAR.sample (itself
   |              overriden by data/configuration/pillar.sls)
   |
   |- data/                  &lt;- exposed through a docker volume
         |- data/            &lt;- persistent data root
         |- configuration/   &lt;- deploy time pillar that is used at reconfigure
                                 time (startup of a pre-built image)
</pre></div>
</div>
</div>
<div class="section" id="initialise-your-dev-environment">
<h2><a class="toc-backref" href="#id11">Initialise your dev environment</a><a class="headerlink" href="#initialise-your-dev-environment" title="Permalink to this headline">¶</a></h2>
<p>We separate the project codebase from any persistent data that is needed to be created along any container.
Those folders will be mounted inside the running container as docker volumes.</p>
<blockquote>
<div><ul class="simple">
<li>one dedicated for the clone of the codebase: <strong>${PROJECT}</strong></li>
<li>one dedicated for the persistent data &amp; configuration: <strong>${DATA}</strong></li>
<li>a subdirectory of data is exposed as a docker volume: <strong>${VOLUME}</strong></li>
</ul>
</div></blockquote>
<p>If you run a prebuilt image, you may not need the project codebase folder.</p>
<p>By convention, the name of the persistant data holding directory is the name of the clone folder suffixed by <code class="docutils literal"><span class="pre">_data</span></code>.
Eg if you clone your project inside <code class="docutils literal"><span class="pre">~/project</span></code>, the data folder will be <code class="docutils literal"><span class="pre">~/project_data</span></code>.
The data folder can&#8217;t and must not be inside the project folder as we drastically play with
unix permissions to enforce proper security and the two of those folders do not have at all the same policies.
The special folder <strong>project_data/volume</strong> is mounted as a docker voume inside the container at the project data directory location. We refer it as <strong>${VOLUME}</strong>.</p>
<p>You need to add a volume that will contains those subdirs:</p>
<blockquote>
<div><dl class="docutils">
<dt>${PROJECT}/</dt>
<dd>git clone of this repository, the project code inside the
container. this folder contains a &#8216;.salt&#8217; folder which
describe how to install &amp; configure this project.
(/srv/projects/&lt;name&gt;/project)</dd>
<dt>${PROJECT}/Dockerfile</dt>
<dd>Dockerfile to build your app</dd>
<dt>${PROJECT}/.salt</dt>
<dd>mc_project configuration to configure your app</dd>
<dt>${DATA}/volume/ aka <strong>${VOLUME}</strong></dt>
<dd>mounted as the persistent data folder inside the container
(/srv/projects/&lt;name&gt;/data)</dd>
<dt>${DATA}/volume/configuration</dt>
<dd>directory holding configuration bits for the running container
that need to be edited or accessible from the host &amp; the user</dd>
<dt>${DATA}/volume/data</dt>
<dd>persistent data</dd>
</dl>
</div></blockquote>
<p>Inside of the data volume, we also differentiate in term of permissions
the configuration from the datas (later is more laxist).
For the configuration directories, after the image has been launched, you ll
certainly need to gain root privileges to re-edit any files in those subdirs.</p>
<p>Project_data in details:</p>
<blockquote>
<div><dl class="docutils">
<dt>${VOLUME}/ssh/*.pub</dt>
<dd>ssh public keys to allow to connect as root</dd>
<dt>${VOLUME}/configuration</dt>
<dd>contains the configuration</dd>
<dt>${VOLUME}/configuration/pillar.sls</dt>
<dd>configuration file (saltstack pillar) for the container</dd>
<dt>${VOLUME}/data/</dt>
<dd>top data dir</dd>
</dl>
</div></blockquote>
<div class="section" id="download-and-initialize-the-layout">
<h3><a class="toc-backref" href="#id12">Download and initialize the layout</a><a class="headerlink" href="#download-and-initialize-the-layout" title="Permalink to this headline">¶</a></h3>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="nb">export</span> <span class="nv">REPO_URL</span><span class="o">=</span><span class="s2">&quot;http://git/orga/repo.git&quot;</span>
<span class="nb">export</span> <span class="nv">PROJECT</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">WORKSPACE</span><span class="si">}</span><span class="s2">/myproject&quot;</span> <span class="c1"># where you want to put the code</span>
<span class="nb">export</span> <span class="nv">DATA</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">PROJECT</span><span class="si">}</span><span class="s2">_data&quot;</span>           <span class="c1"># where you want to put the data</span>
<span class="nb">export</span> <span class="nv">VOLUME</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">DATA</span><span class="si">}</span><span class="s2">/volume&quot;</span>          <span class="c1"># where you want to put the docker volume</span>
mkdir -p <span class="s2">&quot;</span><span class="si">${</span><span class="nv">DATA</span><span class="si">}</span><span class="s2">&quot;</span> <span class="s2">&quot;</span><span class="si">${</span><span class="nv">VOLUME</span><span class="si">}</span><span class="s2">&quot;</span>
git clone <span class="s2">&quot;</span><span class="si">${</span><span class="nv">REPO_URL</span><span class="si">}</span><span class="s2">&quot;</span> <span class="s2">&quot;</span><span class="si">${</span><span class="nv">PROJECT</span><span class="si">}</span><span class="s2">&quot;</span>
</pre></div>
</div>
</div>
<div class="section" id="optionnal-generate-a-a-certificate-with-a-custom-authority-for-testing-purposes">
<h3><a class="toc-backref" href="#id13">OPTIONNAL: Generate a a certificate with a custom authority for testing purposes</a><a class="headerlink" href="#optionnal-generate-a-a-certificate-with-a-custom-authority-for-testing-purposes" title="Permalink to this headline">¶</a></h3>
<p>This script will generate a CA and sign a wildcard certificate for CN=&#8221;${DOMAIN}&#8221; with it
.. code-block:: bash</p>
<blockquote>
<div><p>gen_password() { &lt; /dev/urandom tr -dc _A-Z-a-z-0-9 | head -c${1:-64};echo; }
DATA=&#8221;${<a class="reference external" href="DATA:-$(pwd">DATA:-$(pwd</a>)}&#8221;
CA_PATH=&#8221;${CA_PATH:-${DATA}/ca}&#8221;
C=&#8221;${C:-FR}&#8221;
L=&#8221;${L:-Paris}&#8221;
ST=&#8221;${ST:-IleDeFrance}&#8221;
CA=&#8221;${CA:-&#8220;dockerca&#8221;}&#8221;
EXPIRY=&#8221;${EXPIRY:-$((365*100))}&#8221;
DOMAIN=&#8221;${DOMAIN:-&#8220;registryh.docker.tld&#8221;}&#8221;
mkdir -p &#8220;${CA_PATH}&#8221;
cd &#8220;${CA_PATH}&#8221;
CA_PASSWD=&#8221;$(cat ca_passwd 2&gt;/dev/null)&#8221;
DOMAIN_PASSWD=&#8221;$(cat &#8220;${DOMAIN}_passwd&#8221; 2&gt;/dev/null)&#8221;
CA_PASSWD=&#8221;${CA_PASSWD:-$(gen_password)}&#8221;
DOMAIN_PASSWD=&#8221;${DOMAIN_PASSWD:-$(gen_password)}&#8221;
echo &#8220;$CA_PASSWD&#8221; &gt; ca_passwd
echo &#8220;$DOMAIN_PASSWD&#8221; &gt; &#8220;${DOMAIN}_passwd&#8221;
if ! test -e ca_key.pem;then</p>
<blockquote>
<div>openssl genrsa -des3 -passout <a class="reference external" href="file:ca_passwd">file:ca_passwd</a> -out sca_key.pem
openssl rsa -in sca_key.pem -passin <a class="reference external" href="file:ca_passwd">file:ca_passwd</a> -out ca_key.pem</div></blockquote>
<p>fi
if ! test -e ca.crt;then</p>
<blockquote>
<div><dl class="docutils">
<dt>openssl req -new -x509 -days ${EXPIRY} -key ca_key.pem -out ca.crt</dt>
<dd>-subj &#8220;/C=${C}/ST=${ST}/L=${L}/O=${CA}/CN=${CA}/&#8221;</dd>
</dl>
</div></blockquote>
<p>fi
if ! test -e &#8220;${DOMAIN}_key.pem&#8221;;then</p>
<blockquote>
<div>openssl genrsa -des3 -passout &#8220;file:${DOMAIN}_passwd&#8221; -out &#8220;s${DOMAIN}_key.pem&#8221;
openssl rsa -in &#8220;s${DOMAIN}_key.pem&#8221; -passin &#8220;file:${DOMAIN}_passwd&#8221; -out &#8220;${DOMAIN}_key.pem&#8221;</div></blockquote>
<p>fi
if ! test -e &#8220;${DOMAIN}.crt&#8221;;then</p>
<blockquote>
<div><dl class="docutils">
<dt>openssl req -new -key &#8220;${DOMAIN}_key.pem&#8221; -out &#8220;${DOMAIN}.csr&#8221;</dt>
<dd>-subj &#8220;/C=${C}/ST=${ST}/L=${L}/O=${CA}/CN=*.${DOMAIN}/&#8221;</dd>
<dt>openssl x509 -CAcreateserial -req -days ${EXPIRY} -in ${DOMAIN}.csr</dt>
<dd>-CA ca.crt -CAkey ca_key.pem -out &#8220;${DOMAIN}.crt&#8221;</dd>
</dl>
</div></blockquote>
<p>fi
cat &#8220;${DOMAIN}.crt&#8221; &#8220;ca.crt&#8221;                     &gt; &#8220;${DOMAIN}.bundle.crt&#8221;
cat &#8220;${DOMAIN}.crt&#8221; &#8220;ca.crt&#8221; &#8220;${DOMAIN}_key.pem&#8221; &gt; &#8220;${DOMAIN}.full.crt&#8221;
chmod 644 <em>crt</em>
chmod 640 <em>key</em> <a href="#id2"><span class="problematic" id="id3">*</span></a>full.crt <a href="#id4"><span class="problematic" id="id5">*</span></a>_passwd</p>
</div></blockquote>
</div>
<div class="section" id="register-the-certificate-to-the-host-openssl-configuration">
<h3><a class="toc-backref" href="#id14">Register the certificate to the host openssl configuration</a><a class="headerlink" href="#register-the-certificate-to-the-host-openssl-configuration" title="Permalink to this headline">¶</a></h3>
<div class="highlight-bash"><div class="highlight"><pre><span></span>cat <span class="p">|</span> sudo sh <span class="s">&lt;&lt; EOF</span>
<span class="s">cp &quot;${DATA}/ca/${domain}.bundle.crt /usr/local/share/ca-certificates\</span>
<span class="s">&amp;&amp; update-ca-certificates</span>
<span class="s">EOF</span>
</pre></div>
</div>
</div>
<div class="section" id="configure-the-image-via-the-salt-pillar">
<h3><a class="toc-backref" href="#id15">Configure the image via the salt PILLAR</a><a class="headerlink" href="#configure-the-image-via-the-salt-pillar" title="Permalink to this headline">¶</a></h3>
<dl class="docutils">
<dt>You need then to fill the pillar to reconfigure your container at running time.</dt>
<dd><ul class="first last simple">
<li>setup a domain to serve for the registry (the virtualhost name)</li>
<li>(opt) the SSL certificate informations</li>
</ul>
</dd>
</dl>
<div class="highlight-bash"><div class="highlight"><pre><span></span>mkdir -p <span class="s2">&quot;</span><span class="si">${</span><span class="nv">VOLUME</span><span class="si">}</span><span class="s2">/configuration&quot;</span>
cp .salt/PILLAR.sample <span class="s2">&quot;</span><span class="si">${</span><span class="nv">VOLUME</span><span class="si">}</span><span class="s2">/configuration/pillar.sls&quot;</span>
sed -re <span class="s2">&quot;s/makina-projects.projectname/makina-projects.registry/g&quot;</span><span class="se">\</span>
  -i <span class="s2">&quot;</span><span class="si">${</span><span class="nv">VOLUME</span><span class="si">}</span><span class="s2">/configuration/pillar.sls&quot;</span>
<span class="nv">$EDITOR</span> <span class="s2">&quot;</span><span class="si">${</span><span class="nv">VOLUME</span><span class="si">}</span><span class="s2">/configuration/pillar.sls&quot;</span> <span class="c1"># Adapt to your needs</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="build-run">
<h2><a class="toc-backref" href="#id16">Build &amp; Run</a><a class="headerlink" href="#build-run" title="Permalink to this headline">¶</a></h2>
<p><strong>Be sure to have completed the initial configuration (SSL, PILLAR) before launching the container.</strong>
You may not need to <strong>build</strong> the image, you can directly download it from the docker-hub.</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>docker pull &lt;orga&gt;/&lt;image&gt;
<span class="c1"># or docker build -t &lt;orga&gt;/&lt;image&gt; .</span>
</pre></div>
</div>
<p>Run</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>docker run -ti -v <span class="s2">&quot;</span><span class="si">${</span><span class="nv">VOLUME</span><span class="si">}</span><span class="s2">&quot;</span>:/srv/projects/&lt;project&gt;/data &lt;orga&gt;/&lt;image&gt;
</pre></div>
</div>
<div class="section" id="dns-configuration">
<h3><a class="toc-backref" href="#id17">DNS configuration</a><a class="headerlink" href="#dns-configuration" title="Permalink to this headline">¶</a></h3>
<p>When your container is running and you want to access it locally, in development mode,&lt;br/&gt;
just inspect and register it in your /etc/hosts file can avoid you tedious setup</p>
<p>Assuming that you configured the container to respond to <strong>${DOMAIN}</strong>.</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="nv">IP</span><span class="o">=</span><span class="k">$(</span>sudo docker inspect -f <span class="s1">&#39;{{ .NetworkSettings.IPAddress }}&#39;</span> &lt;YOUR_CONTAINER_ID&gt;<span class="k">)</span>
cat <span class="p">|</span> sudo sh <span class="s">&lt;&lt; EOF</span>
<span class="s">sed -i -re &quot;/${DOMAIN}/d&quot; /etc/hosts</span>
<span class="s">echo $IP ${DOMAIN}&gt;&gt;/etc/hosts</span>
<span class="s">EOF</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="list-of-example-images">
<h2><a class="toc-backref" href="#id18">List of example images</a><a class="headerlink" href="#list-of-example-images" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><a class="reference external" href="https://github.com/makinacorpus/corpus-dockerregistry">docker registry</a></li>
</ul>
</div>
</div>


          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../usage_mastersalt/index.html" class="btn btn-neutral float-right" title="Mastersalt documentation">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="install.html" class="btn btn-neutral" title="Install a makina-states docker environement"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2014 -&gt; 2017, Mathieu Le Marec Pasquet, Régis Leroy &amp; Makina Corpus folks.
    </p>
  </div>

  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
  
</footer>
        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../../',
            VERSION:'1.0',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true
        };
    </script>
      <script type="text/javascript" src="../../_static/jquery.js"></script>
      <script type="text/javascript" src="../../_static/underscore.js"></script>
      <script type="text/javascript" src="../../_static/doctools.js"></script>

  

  
  
    <script type="text/javascript" src="../../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>