

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Icinga configuration &mdash; Makina States 1.0 documentation</title>
  

  
  

  
  <link href='https://fonts.googleapis.com/css?family=Lato:400,700,400italic,700italic|Roboto+Slab:400,700|Inconsolata:400,700&subset=latin,cyrillic' rel='stylesheet' type='text/css'>

  
  
    

  

  
  
    <link rel="stylesheet" href="../../../../_static/css/theme.css" type="text/css" />
  

  

  
    <link rel="top" title="Makina States 1.0 documentation" href="../../../../index.html"/>
        <link rel="up" title="Monitoring services" href="index.html"/>
        <link rel="next" title="Nagvis configuration" href="nagvis.html"/>
        <link rel="prev" title="Client configuration" href="client.html"/> 

  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/modernizr/2.6.2/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-nav-search">
        
          <a href="../../../../index.html" class="fa fa-home"> Makina States</a>
        
        
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
        
          
          
              <ul class="simple">
</ul>
<ul class="simple">
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../api/index.html">Custom states modules</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../../api/modules/index.html">Execution modules</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../api/states/index.html">States modules</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../api/grains/index.html">makina-states grains modules</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../api/api/index.html">Api  modules</a></li>
</ul>
</li>
</ul>
<ul class="current">
<li class="toctree-l1 current"><a class="reference internal" href="../../../index.html">Makina-states V1 documentation (OBSOLETE)</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../../../index.html#usage">Usage</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="../../../index.html#reference">Reference</a></li>
</ul>
</li>
</ul>

          
        
      </div>
      &nbsp;
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../../../../index.html">Makina States</a>
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../../../../index.html">Docs</a> &raquo;</li>
      
          <li><a href="../../../index.html">Makina-states V1 documentation (OBSOLETE)</a> &raquo;</li>
      
          <li><a href="../../../ref_index.html">Reference</a> &raquo;</li>
      
          <li><a href="../../index.html">Makina-states Formulaes</a> &raquo;</li>
      
          <li><a href="../index.html">Services</a> &raquo;</li>
      
          <li><a href="index.html">Monitoring services</a> &raquo;</li>
      
    <li>Icinga configuration</li>
      <li class="wy-breadcrumbs-aside">
        
          <a href="../../../../_sources/v1/ref_formulaes/services/monitoring/icinga.txt" rel="nofollow"> View page source</a>
        
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document">
            
  <div class="section" id="icinga-configuration">
<h1>Icinga configuration<a class="headerlink" href="#icinga-configuration" title="Permalink to this headline">¶</a></h1>
<p>See <a class="reference internal" href="../../../../api/modules/mc_icinga.html#module-mc-icinga"><span>mc_icinga / icinga functions</span></a> for configuration options.</p>
<div class="section" id="about-packaging">
<h2>About packaging<a class="headerlink" href="#about-packaging" title="Permalink to this headline">¶</a></h2>
<p>The icinga module can provide:</p>
<blockquote>
<div><ul class="simple">
<li>configuration of icinga core</li>
<li>configuration of database for ido2db</li>
<li>configuration of ido2db daemon</li>
<li>configuration of uwsgi in order to serve cgi</li>
<li>configuration of nginx to serve cgi through uwsgi</li>
<li>configuration of icinga (add/remove objects configuration)</li>
</ul>
</div></blockquote>
<p>The icinga_web module can provide:</p>
<blockquote>
<div><ul class="simple">
<li>configuration of icinga web</li>
<li>configuration of database for icinga web</li>
<li>configuration of php-fpm</li>
<li>configuration of nginx to serve php webpages through php-fpm</li>
</ul>
</div></blockquote>
<p>icinga_web module can configure its nginx virtualhost to serve cgi but icinga_web module doesn&#8217;t configure uwsgi and doesn&#8217;t install any file related to cgi.</p>
<p>The reason is to keep icinga and icinga_web independants.
icinga-web and icinga can be installed on two differents hosts but CGI files require to have icinga-core installed on the host.</p>
<p>icinga_web module depends on icinga module only if cgi is enabled in icinga-web virtualhost (makina-states.services.monitoring.icinga_web.nginx.icinga_cgi.enabled is set to True).</p>
<p>In the same way, icinga_web doesn&#8217;t depends on pnp4nagios even if the module is enabled.
You have to install pnp4nagios separately.</p>
<p>The mysql configuration doesn&#8217;t work.</p>
<p>The architecture of service folder looks like to :</p>
<blockquote>
<div><table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">init.sls:</th><td class="field-body">is the file which includes the others</td>
</tr>
<tr class="field-even field"><th class="field-name">hooks.sls:</th><td class="field-body">defines some states for schedule</td>
</tr>
<tr class="field-odd field"><th class="field-name">macros.jinja:</th><td class="field-body">is empty because I don&#8217;t have used macros for icinga and icinga_web</td>
</tr>
<tr class="field-even field"><th class="field-name" colspan="2">prerequisites.sls:</th></tr>
<tr class="field-even field"><td>&nbsp;</td><td class="field-body">defines states which install packages</td>
</tr>
<tr class="field-odd field"><th class="field-name" colspan="2">configuration.sls:</th></tr>
<tr class="field-odd field"><td>&nbsp;</td><td class="field-body">defines states which write configuration and init scripts</td>
</tr>
<tr class="field-even field"><th class="field-name">services.sls:</th><td class="field-body">defines states which start the service</td>
</tr>
<tr class="field-odd field"><th class="field-name">pgsql.sls:</th><td class="field-body">the states which install and configure postgresql if this dependance is needed. The states are called before ones in prerequisites.sls</td>
</tr>
<tr class="field-even field"><th class="field-name">mysql.sls:</th><td class="field-body">the states which install and configure mysql if this dependance is needed. The states are called before ones in prerequisites.sls</td>
</tr>
<tr class="field-odd field"><th class="field-name">nginx.sls:</th><td class="field-body">the states which install and configure nginx and phpfpm if theses dependances are needed. The states are called before ones in prerequisites.sls</td>
</tr>
</tbody>
</table>
</div></blockquote>
<p>For &#8220;pgsql.sls&#8221;, &#8220;mysql.sls&#8221; and &#8220;nginx.sls&#8221;, I don&#8217;t have separated the states between prerequisites, configuration and services.</p>
<p>The architecture between Icinga, Icinga-web and nagvis looks like to:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span>icinga---ido2db---------&gt;&lt;-postgresql-&gt;&lt;---icinga-web
     |
     +---mklivestatus---&gt;&lt;-----------------nagvis
     |
     +---npcdmod--------&gt;&lt;-npcd-&gt;&lt;-rrd-&gt;&lt;--pnp4nagios
</pre></div>
</div>
<p>Please note that icinga service offers four special macros to generate configurations. Theses macros are described below.</p>
</div>
<div class="section" id="configuration">
<h2>Configuration<a class="headerlink" href="#configuration" title="Permalink to this headline">¶</a></h2>
<p>In configuration.sls, the general configuration of icinga and the objects configuration are made
For the objects configuration, some macros are called automatically with the content defined in:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">makina</span><span class="o">-</span><span class="n">states</span><span class="o">.</span><span class="n">services</span><span class="o">.</span><span class="n">monitoring</span><span class="o">.</span><span class="n">icinga</span><span class="o">.</span><span class="n">objects</span>
</pre></div>
</div>
<p>This dictionary architecture looks like:</p>
<blockquote>
<div><table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">directory:</th><td class="field-body">directory in which configurations files will be written (default: /etc/icinga/objects/salt_generated)</td>
</tr>
<tr class="field-even field"><th class="field-name" colspan="2">objects_definition:</th></tr>
<tr class="field-even field"><td>&nbsp;</td><td class="field-body">dictionary in which each subdictionary is given to &#8220;configuration_add_object&#8221; macro as **kwargs. It is used to define objects like contacts or timeperiods or commands</td>
</tr>
<tr class="field-odd field"><th class="field-name" colspan="2">autoconfigured_hosts_definitions:</th></tr>
<tr class="field-odd field"><td>&nbsp;</td><td class="field-body">dictionary in which each subdictionary is given to &#8220;configuration_add_auto_host&#8221; macro as **kwargs. It is used to define hosts and hostgroups and add services associated to them.</td>
</tr>
<tr class="field-even field"><th class="field-name" colspan="2">purge_definitions:</th></tr>
<tr class="field-even field"><td>&nbsp;</td><td class="field-body">a list of files or directory which can be deleted. Each element of the list is given to &#8220;configuration_remove_object&#8221; macro as **kwargs)</td>
</tr>
</tbody>
</table>
</div></blockquote>
<p>The &#8220;purge_definitions&#8221; list is used to remove hosts. because a call to &#8220;configuration_add_auto_host&#8221; macro with all services disabled will remove only the services and not the host itself.</p>
</div>
<div class="section" id="macros">
<h2>Macros<a class="headerlink" href="#macros" title="Permalink to this headline">¶</a></h2>
<div class="section" id="configuration-add-object">
<h3>configuration_add_object<a class="headerlink" href="#configuration-add-object" title="Permalink to this headline">¶</a></h3>
<p>This macro was written in order to add an object in the icinga configuration</p>
<div class="highlight-python"><div class="highlight"><pre><span></span>{% import &quot;makina-states/services/monitoring/icinga/init.sls&quot; as icinga with context %}
{{ icinga.configuration_add_object(type, file, attrs, definition, **kwargs) }}
</pre></div>
</div>
<p>with</p>
<blockquote>
<div><table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">type:</th><td class="field-body">the type of added object</td>
</tr>
<tr class="field-even field"><th class="field-name">file:</th><td class="field-body">the filename of the added object</td>
</tr>
<tr class="field-odd field"><th class="field-name">attrs:</th><td class="field-body">a dictionary in which each key corresponds to a directive</td>
</tr>
<tr class="field-even field"><th class="field-name">definition:</th><td class="field-body">the name used to identify the definition. It is the name used by configuration_edit_object. If none, configuration_edit_object will not work for this definition</td>
</tr>
</tbody>
</table>
</div></blockquote>
<p>The default directory where configuration files are located is:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span>/etc/icinga/objects/salt_generated/
</pre></div>
</div>
<p>The directory can be modified in the &#8220;makina-states.services.monitoring.icinga.objects&#8221; dictionary</p>
<p>You can change the configuration directory using **kwargs parameter</p>
<p>A call with:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="p">{{</span> <span class="n">icinga</span><span class="o">.</span><span class="n">configuration_add_object</span><span class="p">(</span>
                               <span class="nb">type</span><span class="o">=</span><span class="s1">&#39;host&#39;</span><span class="p">,</span>
                               <span class="nb">file</span><span class="o">=</span><span class="s1">&#39;hosts/hostname1.cfg&#39;</span><span class="p">,</span>
                               <span class="n">attrs</span><span class="o">=</span><span class="p">{</span>
                                        <span class="s1">&#39;host_name&#39;</span><span class="p">:</span> <span class="s2">&quot;hostname1&quot;</span><span class="p">,</span>
                                        <span class="s1">&#39;use&#39;</span><span class="p">:</span> <span class="s2">&quot;generic-host&quot;</span><span class="p">,</span>
                                    <span class="p">},</span>
                              <span class="p">)</span> <span class="p">}}</span>
</pre></div>
</div>
<p>Generates the file in /etc/icinga/objects/salt_generated/host/hostname1.cfg containing:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span>define host {
 use=generic-host
 host_name=hostname1
}
</pre></div>
</div>
<p>The services are managed in the same way:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="p">{{</span> <span class="n">icinga</span><span class="o">.</span><span class="n">configuration_add_object</span><span class="p">(</span>
                               <span class="nb">type</span><span class="o">=</span><span class="s1">&#39;service&#39;</span><span class="p">,</span>
                               <span class="nb">file</span><span class="o">=</span><span class="s1">&#39;services/SSH&#39;</span><span class="p">,</span>
                               <span class="n">attrs</span><span class="o">=</span><span class="p">{</span>
                                        <span class="s1">&#39;use&#39;</span><span class="p">:</span> <span class="s2">&quot;generic-service&quot;</span><span class="p">,</span>
                                        <span class="s1">&#39;service_description&#39;</span><span class="p">:</span> <span class="s2">&quot;SSH&quot;</span><span class="p">,</span>
                                    <span class="p">},</span>
                              <span class="p">)</span> <span class="p">}}</span>
</pre></div>
</div>
<p>That generates the file /etc/icinga/objects/salt_generated/service/SSH.cfg containing:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span>define service {
 use=generic-service
 service_description=SSH
}
</pre></div>
</div>
</div>
<div class="section" id="configuration-remove-object">
<h3>configuration_remove_object<a class="headerlink" href="#configuration-remove-object" title="Permalink to this headline">¶</a></h3>
<p>This macro was written in order to remove an object in the icinga configuration</p>
<div class="highlight-python"><div class="highlight"><pre><span></span>{% import &quot;makina-states/services/monitoring/icinga/init.sls&quot; as icinga with context %}
{{ icinga.configuration_remove_object(file, **kwargs) }}
</pre></div>
</div>
<p>with</p>
<blockquote>
<div><table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">file:</th><td class="field-body">the filename of the added object</td>
</tr>
</tbody>
</table>
</div></blockquote>
<p>The default directory where configuration files are located is:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span>/etc/icinga/objects/salt_generated/
</pre></div>
</div>
<p>The directory can be modified in the &#8220;makina-states.services.monitoring.icinga.objects&#8221; dictionary</p>
</div>
<div class="section" id="configuration-edit-object">
<h3>configuration_edit_object<a class="headerlink" href="#configuration-edit-object" title="Permalink to this headline">¶</a></h3>
<p>This macro was written because some values in object configuration depends on the rest of the configuration.</p>
<p>For example, you can have:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">host_name</span><span class="o">=</span><span class="n">host1</span><span class="p">,</span><span class="n">host2</span><span class="p">,</span><span class="n">host3</span>
</pre></div>
</div>
<p>in a service definition</p>
<p>But when you call the configuration_add_object, you don&#8217;t know what hosts will be listed in this directive.</p>
<div class="highlight-python"><div class="highlight"><pre><span></span>{% import &quot;makina-states/services/monitoring/icinga/init.sls&quot; as icinga with context %}
{{ icinga.configuration_edit_object(type, file, attr, value, auto_host, definition, **kwargs) }}
</pre></div>
</div>
<p>with</p>
<blockquote>
<div><table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">type:</th><td class="field-body">the type of edited object</td>
</tr>
<tr class="field-even field"><th class="field-name">file:</th><td class="field-body">the name of the edited object</td>
</tr>
<tr class="field-odd field"><th class="field-name">attr:</th><td class="field-body">the directive for which a value must be added</td>
</tr>
<tr class="field-even field"><th class="field-name">value:</th><td class="field-body">the value added</td>
</tr>
<tr class="field-odd field"><th class="field-name">auto_host:</th><td class="field-body">true if the file is a file created with configuration_add_auto_host macro</td>
</tr>
<tr class="field-even field"><th class="field-name">definition:</th><td class="field-body">the definition to edit in the file</td>
</tr>
</tbody>
</table>
</div></blockquote>
<p>The &#8220;file&#8221; argument value is relative to &#8220;makina-states.services.monitoring.icinga.objects.directory&#8221; (default: /etc/icinga/objects/salt_generated/)</p>
<p>The old values of the attr directive are not removed.</p>
<p>If you call:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="p">{{</span> <span class="n">icinga</span><span class="o">.</span><span class="n">configuration_edit_object</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="s1">&#39;service&#39;</span><span class="p">,</span>
                                    <span class="nb">file</span><span class="o">=</span><span class="s1">&#39;SSH.cfg&#39;</span><span class="p">,</span>
                                    <span class="n">attr</span><span class="o">=</span><span class="s1">&#39;host_name&#39;</span><span class="p">,</span>
                                    <span class="n">value</span><span class="o">=</span><span class="s1">&#39;hostname1&#39;</span><span class="p">)</span> <span class="p">}}</span>
</pre></div>
</div>
<p>the previous service definition becomes:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span>define service {
 use=generic-service
 service_description=SSH
 host_name=hostname1
}
</pre></div>
</div>
<p>If you recall the macro with a different value:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="p">{{</span> <span class="n">icinga</span><span class="o">.</span><span class="n">configuration_edit_object</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="s1">&#39;service&#39;</span><span class="p">,</span>
                                    <span class="nb">file</span><span class="o">=</span><span class="s1">&#39;SSH.cfg&#39;</span><span class="p">,</span>
                                    <span class="n">attr</span><span class="o">=</span><span class="s1">&#39;host_name&#39;</span><span class="p">,</span>
                                    <span class="n">value</span><span class="o">=</span><span class="s1">&#39;hostname2&#39;</span><span class="p">)</span> <span class="p">}}</span>
</pre></div>
</div>
<p>the previous service definition becomes:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span>define service {
 use=generic-service
 service_description=SSH
 host_name=hostname1,hostname2
}
</pre></div>
</div>
<p>when auto_host is set to true, the value for definition argument are:</p>
<blockquote>
<div><ul class="simple">
<li>definition=&#8217;host&#8217;: or definition=&#8217;hostgroup&#8217; the attribute will be added in the host/hostgroup definition</li>
<li>definition=service: the attribute will be added in service definition. service have to be in the service list and have to be enabled</li>
<li>definition=service-name: the attribute will be added in service loop definition.</li>
</ul>
</div></blockquote>
</div>
<div class="section" id="limits">
<h3>Limits<a class="headerlink" href="#limits" title="Permalink to this headline">¶</a></h3>
<p>Currently, the macro doesn&#8217;t edit the icinga.cfg file in order to add the directory in the list of &#8220;cfg_dir&#8221;
You should think to make a coherent configuration.</p>
<p>By default, the /etc/icinga/objects is present in &#8220;cfg_dir&#8221;.</p>
<p>No checks are done. You can generate invalid values for any directives. You can set non-existent directives too.</p>
</div>
<div class="section" id="configuration-add-auto-host">
<h3>configuration_add_auto_host<a class="headerlink" href="#configuration-add-auto-host" title="Permalink to this headline">¶</a></h3>
<p>This macro is designed to add an host and associated services</p>
<div class="highlight-python"><div class="highlight"><pre><span></span>{% import &quot;makina-states/services/monitoring/icinga/init.sls&quot; as icinga with context %}
{% icinga.configuration_add_auto_host(hostname,
                                      hostgroup=False,
                                      attrs={},
                                      ssh_user=&#39;root&#39;,
                                      ssh_addr=&#39;&#39;,
                                      ssh_port=22,
                                      ssh_timeout=30,
                                      backup_burp_age=False,
                                      backup_rdiff=False,
                                      beam_process=False,
                                      celeryd_process=False,
                                      cron=False,
                                      ddos=false,
                                      debian_updates=False,
                                      dns_association_hostname=False,
                                      dns_association=False,
                                      dns_reverse_association=False,
                                      disk_space=False,
                                      disk_space_root=False,
                                      disk_space_var=False,
                                      disk_space_srv=False,
                                      disk_space_tmp=False,
                                      disk_space_data=False,
                                      disk_space_mnt_data=False,
                                      disk_space_home=False,
                                      disk_space_var_lxc=False,
                                      disk_space_var_makina=False,
                                      disk_space_var_mysql=False,
                                      disk_space_var_www=False,
                                      disk_space_backups=False,
                                      disk_space_backups_guidtz=False,
                                      disk_space_var_backups_bluemind=False,
                                      disk_space_var_spool_cyrus=False,
                                      disk_space_nmd_www=False,
                                      drbd=False,
                                      epmd_process=False,
                                      erp_files=False,
                                      fail2ban=False,
                                      gunicorn_process=False,
                                      haproxy=False,
                                      ircbot_process=False,
                                      load_avg=False,
                                      mail_cyrus_imap_connections=False,
                                      mail_imap=False,
                                      mail_imap_ssl=False,
                                      mail_pop=False,
                                      mail_pop_ssl=False,
                                      mail_pop_test_account=False,
                                      mail_server_queues=False,
                                      mail_smtp=False,
                                      megaraid_sas=False,
                                      memory=False,
                                      memory_hyperviseur=False,
                                      mysql_process=False,
                                      network=False,
                                      ntp_peers=False,
                                      ntp_time=False,
                                      only_one_nagios_running=False,
                                      postgres_port=False,
                                      postgres_process=False,
                                      prebill_sending=False,
                                      raid=False,
                                      sas=False,
                                      snmpd_memory_control=False,
                                      solr=False,
                                      ssh=False,
                                      supervisord_status=False,
                                      swap=False,
                                      tiles_generator_access=False,
                                      ware_raid=False,
                                      web_apache_status=False,
                                      web_openid=False,
                                      web=False,
                                      services_attrs={}
                                     ) %}
</pre></div>
</div>
<p>with</p>
<blockquote>
<div><table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">hostname:</th><td class="field-body">the hostname of the added host</td>
</tr>
<tr class="field-even field"><th class="field-name">hostgroup:</th><td class="field-body">if true, a hostgroup will be added instead of a simple host (because it is possible to add services for a hostgroup)</td>
</tr>
<tr class="field-odd field"><th class="field-name">attrs:</th><td class="field-body">a dictionary in which each key corresponds to a directive in the host definition</td>
</tr>
<tr class="field-even field"><th class="field-name">ssh_user:</th><td class="field-body">user to connect the host (it is used by check_by_ssh command)</td>
</tr>
<tr class="field-odd field"><th class="field-name">ssh_addr:</th><td class="field-body">address used to do the ssh connection in order to perform check_by_ssh. this address is not the hostname address becasue we can use a ssh gateway</td>
</tr>
<tr class="field-even field"><th class="field-name">ssh_port:</th><td class="field-body">ssh_port</td>
</tr>
<tr class="field-odd field"><th class="field-name">[service]:</th><td class="field-body">a boolean to indicate that the service [service] has to be added</td>
</tr>
<tr class="field-even field"><th class="field-name">services_attrs:</th><td class="field-body">a dictionary to override the default values for each service definition and to ad additional values. The keys begining with &#8220;cmdarg_&#8221; are the check command arguments. Each subdictionary corresponds to a service.</td>
</tr>
</tbody>
</table>
</div></blockquote>
<p>Some services use an additional subdictionary because they can be defined several times. It is the case of</p>
<blockquote>
<div><ul class="simple">
<li>dns_association</li>
<li>dns_reverse_assocation</li>
<li>disk_space</li>
<li>network</li>
<li>solr</li>
<li>web_openid</li>
<li>web</li>
</ul>
</div></blockquote>
<p>For theses services, you may complete the services_attrs dictionary by adding a subsubdictionary
(the dictionary associatio to &#8216;a_service&#8217; key here):</p>
<div class="highlight-python"><div class="highlight"><pre><span></span>service_attrs: {
    &#39;dns_association&#39;: {
        &#39;a_service&#39;: {
            &#39;cmdarg_hostname&#39;: &quot;www.example.net&quot;,
        }
    }
}
</pre></div>
</div>
<p>You can add several dns_association, disk_space, network, solr, web_openid, web</p>
<p>For others services, the directives are not in a subsubdctionary but directly in the subdictionary:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span>service_attrs: {
    &#39;raid&#39;: {
        &#39;check_command&#39;: &quot;check&quot;,
    }
}
</pre></div>
</div>
<p>You have to insert in services_attrs only the non default values.</p>
<p>Note: The directive &#8220;host_name&#8221; will not be taken into account.
The value will be replaced with the value of &#8220;hostname&#8221; macro argument</p>
<p>The host is added in /etc/icinga/objects/salt_generated/&lt;hostname&gt;/host.cfg
The services are added in this directory too (for ssh it will be /etc/icinga/objects/salt_generated/&lt;hostname&gt;/ssh.cfg)</p>
<p>The services are defined specially for the host.
There is no:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span>define service {
    host_name host1,host2
}
</pre></div>
</div>
<p>The commands definitions are located in objects/objects_defintions subdictionary in mc_icinga.py
They are installed with a state in configuration.sls.</p>
<p>All the commands objects are created even if no service use them.</p>
<p>All the complexity is in &#8220;mc_icinga.add_auto_configuration_host_settings&#8221; function (see <a class="reference internal" href="../../../../api/modules/mc_icinga.html#module-mc-icinga"><span>mc_icinga / icinga functions</span></a>)</p>
<p>The macro only adds the host (or hostgroup) by calling &#8220;configuration_add_object&#8221; and browses the services.</p>
<dl class="docutils">
<dt>if the service is enabled:</dt>
<dd>a state adds the service configuration file by calling the &#8220;configuration_add_object&#8221; macro</dd>
<dt>if the service is disabled:</dt>
<dd>a state removes the service configuration file by calling the &#8220;configuration_remove_object&#8221; macro</dd>
</dl>
<p>For each host, a state is executed for each service even if all the services are disabled.
The execution takes about 30 minutes for 128 hosts and 50 services (the macro configuration_add_object is called 939 times and configuration_remove_object is called 6158 times
(yes, it doesn&#8217;t correspond to 50*128 because there are the commands definitions, contacts, ...)).</p>
<p>The speed can be improved by removing the &#8220;watch_in&#8221; directive in the &#8220;configuration_remove_object&#8221; macro (because this macro is called a lot of time).</p>
<p>Without this directive. the execution takes about 10 minutes for 128 hosts and 50 services but the configuration files are removed after the restart of icinga.</p>
<p>I don&#8217;t have find how to fix this problem. I used a &#8220;order: 1&#8221; directive but in this case the states are executed before prerequisite (which is less problematic than when the execution was after the restart of icinga. The files are deleted before the creation of new files. If a file is in &#8220;purge_definitions&#8221; dictionary and is created in another macro call. The file will be deleted and recreated in a next state)</p>
<p>Another idea is to delete several configuration files with only one state.</p>
<p>Off topic:
I have used &#8220;order&#8221; directive in configuration_add_object macro too. (the execution time seems to be the same without any directive like order or watch_in and with a order directive)</p>
<p>The execution is 629.685 secondes for 128 hosts, 50 services and &#8220;order&#8221; instead of &#8220;watch_in&#8221; in &#8220;configuration_add_object&#8221; and &#8220;configuration_remove_object&#8221;</p>
<p>Without the &#8220;order&#8221; directive in configuration_add_object macro but with a &#8220;watch_in&#8221; directive, the execution is 820.238 secondes.</p>
<p>The difference is 190.553 for 939 &#8220;watch_in&#8221; (the 939 call of &#8220;configuration_add_object&#8221; macro). So a &#8220;watch_in&#8221; directive take 0.203 secondes</p>
<p>With 6158 &#8220;watch_in&#8221; for &#8220;configuration_remove_object&#8221;, it is (0.203*6158) 1249.654 secondes (about 20 minutes).</p>
<p>I have supposed &#8220;watch_in&#8221; execution time constant.</p>
<p>With 50 services per hosts (ignore services_loop which can increase the number of services): The host autoconfiguration macro need about 10.353 secondes to execute &#8220;watch_in&#8221; directives in one call.</p>
<p>With about 360 hosts the excessive execution time approach the entire hour.</p>
<p>The issue was resolved by decreasing the number of states: there is only one state to create each host.
The services for the host are in the same file.</p>
<p>This decrease the number of states and the call to configuration_remove_object is useless to delete old services because the file with services of the hosts
is naturally edited.</p>
<p>The execution time decrease to 1 minute about for 128 hosts but with 1000 hosts it ran out of memory.
However, it is perhaps a bad idea to have all services in a same file because the files becomes long.</p>
<p>The memory problem was solved by moving the &#8220;object&#8221; subdiction so that it is not cached.
Only a list of hosts is cached is &#8220;object&#8221; subdictionary.</p>
<p>The function &#8220;get_settings_for_object&#8221; is designed to get non cached values.</p>
<p>An other modification is that the macro doesn&#8217;t give the data to template.
Before the modification it was:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span>{% set data = salt[&#39;mc_icinga.add_auto_configuration_host_settings&#39;](...) %}
icinga-configuration-{{data.state_name_salt}}-add-auto-host-conf:
    ...
    - defaults
      data: |
            {{sdata}}
</pre></div>
</div>
<p>Now, the data are stored in a light dictionary in global variables in &#8220;mc_icinga.add_auto_configuration_host.objects&#8221;
In the macro there is:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span>{% set data = salt[&#39;mc_icinga.add_auto_configuration_host&#39;](...) %}
icinga-configuration-{{data.state_name_salt}}-add-auto-host-conf:
    ...
    - defaults
      hostname: |
            {{salt[&#39;mc_utils.json_dump&#39;](data.hostname}}
</pre></div>
</div>
<p>The function &#8220;mc_icinga.add_auto_configuration_host&#8221; stores the object informations in a dictionary like:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="p">{</span>
    <span class="s1">&#39;hostname&#39;</span><span class="p">:</span> <span class="p">{}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Each subdictionary contains all arguments given to the macro.
But this methods requires to store a lot of data. For objects which are in localsettings, I have added a &#8220;fromsetting&#8221; argument. Instead of store all arguments given to the macro, only the key in localsettings is stored:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="p">{</span>
    <span class="s1">&#39;hostname&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;fromsettings&#39;</span><span class="p">:</span> <span class="s1">&#39;host1&#39;</span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Only key of this dictionary is given to template.
The template get the object from localsettings by calling &#8220;get_settings_for_object&#8221; if a &#8220;fromsettings&#8221; key is found.
And the settings are given to the previous &#8220;mc_icinga.add_auto_configuration_host_settings&#8221; function.</p>
<p>All is done in the template in order to avoid store a lot of data in memory during a long time.
Then, a lot of memory is used during template compilation, when:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span>default:
  data: |
        {{sdata}}
</pre></div>
</div>
<p>is replaced with:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span>default:
  data: |
        {a big dictionary here which is the return of utf8 encode in order to use more memory}
</pre></div>
</div>
<p>With theses modifications, it is possible to manage only 7000 hosts with 10 services per host with 1Go of memory (another 800Mo of memory is needed to run salt-master).</p>
</div>
<div class="section" id="add-a-new-service-in-configuration-add-auto-host-macro">
<h3>Add a new service in configuration_add_auto_host macro<a class="headerlink" href="#add-a-new-service-in-configuration-add-auto-host-macro" title="Permalink to this headline">¶</a></h3>
<p>If you want add a new service managed with this macro, you have to:</p>
<blockquote>
<div><ol class="arabic simple">
<li>add arguments in macro and in add_auto_configuration_host_settings function</li>
<li>add the service in &#8220;services&#8221; or &#8220;services_loop&#8221; list</li>
<li>add the default values in &#8220;services_default_attrs&#8221;</li>
<li>if the service was added in &#8220;services_loop&#8221; list, add code to merge dictionaries</li>
<li>if the default &#8220;check_command&#8221; is new, add a &#8220;command&#8221; definition in
&#8220;objects_definitions&#8221; dictionary (in &#8220;objects&#8221; function)
and add the command with its arguments in &#8220;check_command_args&#8221;</li>
</ol>
</div></blockquote>
</div>
</div>
</div>


          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="nagvis.html" class="btn btn-neutral float-right" title="Nagvis configuration">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="client.html" class="btn btn-neutral" title="Client configuration"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2014 -&gt; 2017, Mathieu Le Marec Pasquet, Régis Leroy &amp; Makina Corpus folks.
    </p>
  </div>

  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
  
</footer>
        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../../../../',
            VERSION:'1.0',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true
        };
    </script>
      <script type="text/javascript" src="../../../../_static/jquery.js"></script>
      <script type="text/javascript" src="../../../../_static/underscore.js"></script>
      <script type="text/javascript" src="../../../../_static/doctools.js"></script>

  

  
  
    <script type="text/javascript" src="../../../../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>