{% import "makina-states/_macros/services.jinja" as services with context %}
{% set localsettings = salt['mc_localsettings.settings']() %} %}

{% set nginxSettings = salt['mc_nginx.settings']() %}
{% macro virtualhost(
  site = 'example.com',
  small_name = None,
  active = True,
  port = '80',
  documentRoot = None,
  server_aliases = None,
  redirect_aliases = True,
  allowed_hosts = ['localhost'],
  vh_template_source = 'salt://makina-states/files/etc/nginx/sites-available/vhost.conf',
  extra_jinja_nginx_variables = None
  ) %}

{% set small_name = small_name or site.replace('.', '_').replace('-', '_') %}
{% set doc_root = documentRoot or salt['mc_localsettings.settings']()['locations'].projects_dir + site  + '/www' %}
{% set vhost_available_file = nginxSettings.basedir + "/sites-available/" + site + ".conf" %}
{% set vhost_enabled_file = nginxSettings.basedir + "/sites-enabled/" + site + ".conf" %}

# Virtualhost basic file
makina-nginx-virtualhost-{{ small_name }}:
  file.managed:
    - user: root
    - group: root
    - mode: 664
    - name: {{ vhost_available_file }}
    - source: {{ vh_template_source }}
    - template: 'jinja'
    - defaults:
        small_name: "{{ small_name }}"
        document_root: "{{ doc_root }}"
        server_name: "{{ site }}"
        {% if server_aliases %}
        server_aliases:
          {% for server_alias in server_aliases %}
          - {{ server_alias }}
          {% endfor %}
        {% endif %}
        {% if allowed_hosts %}
        allowed_hosts:
          {% for allowed_host in allowed_hosts %}
          - {{ allowed_host }}
          {% endfor %}
        {% endif %}
        redirect_aliases: {{ redirect_aliases }}
        port: "{{ port }}"
{% if extra_jinja_nginx_variables %}
{% for variablename,variablevalue in extra_jinja_nginx_variables.iteritems() %}
        {{ variablename }}: "{{ variablevalue }}"
{% endfor %}
{% endif %}
    - require:
      - pkg: makina-nginx-pkgs
    - watch_in:
      - cmd: makina-nginx-virtualhost-{{ small_name }}-status
      - cmd: makina-nginx-conf-syntax-check
      - service: makina-nginx-reload

# Virtualhost status

makina-nginx-virtualhost-{{ small_name }}-status:
  cmd.run:
{%      if active %}
    - name: ln -s {{ vhost_available_file }} {{ vhost_enabled_file }}
    - unless: ls {{ vhost_enabled_file }}
{%      else %}
    - name: rm -f {{ vhost_enabled_file }}
    - onlyif: ls {{ vhost_enabled_file }}
{%      endif %}
    - require:
      - pkg: makina-nginx-pkgs
    - watch_in:
      - cmd: makina-nginx-conf-syntax-check
      - service: makina-nginx-reload

{% endmacro %}
