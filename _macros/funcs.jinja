{#-
# common macros
#
# Current graph of the macros inheritance:
#
#               |
#               |
#               |
#               |____________________________
#                           |                |
#                    nodetypes.jinja         |
#                      |        |    controllers.jinja
#                      |        |            |
#                      |        |            |
#        localsettings.jinja    |            |
#          |               |____|            |
#          |                    |            |
#          |           services.jinja        |
#          |                                 |
#          |_________________________________|
#
#
#
#  to break the controllers/nodetypes cycle;
#  at bootstrap time, we build first nodetypes then
#  controllers
#}
{# DEPRECATED but never ever remove this file to not break api v1#}
{% macro proxy(name, text='') %}
{{name}}:
  mc_proxy.hook:
    - name: {{name}}
{{text}}
{% endmacro %}

{% macro autocommit(akind) %}
{% set locations = salt['mc_localsettings.settings']()['locations'] %}
{# be sure to run at the end of provisionning to commit
# /etc changes #}
{# we do not depend directly on localsettings
# because of interrecursivity but verify that those
# steps are always executed after etckeeper main
# installation
#}
{{akind}}-final-etckeeper-run:
  cmd.run:
    - order: last
    - name: {{locations.conf_dir}}/cron.daily/etckeeper "commit from salt"
    - onlyif: >
        test -e {{locations.conf_dir}}/cron.daily/etckeeper
        &&
        test -e $(which etckeeper 2>/dev/null)
{% endmacro %}

{# retro compat #}
{% set dummy = proxy %}
# vim:set nofoldenable:
