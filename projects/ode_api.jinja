{%- import "makina-states/projects/python.jinja" as python with context %}
{% import "makina-states/services/db/postgresql.sls" as pgsql with context %}
{%- set services = python.services %}
{%- set localsettings = salt['mc_localsettings.settings']() %}

{% macro install_python(common) %}
{{ python.install_generic_python_project(*varargs, **kwargs) }}
{% endmacro %}

{% macro install_pgsql(common) %}
{% set db_name = salt['mc_utils.get']('makina-states.projects.ode_api.db_name', 'ode') %}
{% set db_user = salt['mc_utils.get']('makina-states.projects.ode_api.db_user', 'ode') %}
{% set db_password = salt['mc_utils.get']('makina-states.projects.ode_api.db_password', 'ode') %}

{{ pgsql.postgresql_db(db_name) }}
{{ pgsql.postgresql_user(db_user, db_password, groups=['{0}_owners'.format(db_name)]) }}
{% endmacro %}

{% macro install_setup(common) %}
ode_project_setup:
  cmd.run:
    - name: >
        . .virtualenv/bin/activate
        && python setup.py develop
        && .virtualenv/bin/initialize_ode_db production.ini
        && python setup.py compile_catalog -l fr
    - cwd: {{ common['project_root'] }}
{% endmacro %}

{% macro install_ode_api_project() %}
{% do kwargs.setdefault('url', 'https://github.com/makinacorpus/ODE.git') -%}
{% do kwargs.setdefault('name', 'ode_api') -%}
{% do kwargs.setdefault('domain', 'example.com') -%}
{% do kwargs.setdefault('sls_includes', [
  'makina-states.services.db.postgresql',
  'makina-states.localsettings.python'
  ]) -%}

{% set common = salt['mc_project.get_common_vars'](services, *varargs, **kwargs) -%}

{# also install pgsql through include -#}
{{ install_python(common, *varargs, **kwargs) }}
{{ install_pgsql(common) }}
{{ install_setup(common) }}
{% endmacro %}
