<!DOCTYPE html>
<html lang="en"><head>
<meta name="robots" content="noindex"><meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>LXC containers management | Makina States</title><meta name="description" content="" />
<meta property="og:type" content="article" />
<meta property="og:article:published_time" content="0001-01-01T00:00:00Z" />
<meta property="og:article:modified_time" content="0001-01-01 00:00:00 &#43;0000 UTC" /><meta property="og:article:tag" content="cloud" /><meta property="og:article:tag" content="lxc" /><meta property="og:locale" content="en_US">
<meta property="og:title" content="LXC containers management">
<meta property="og:image" content="/images/">
<meta property="og:image:type" content="image/jpeg" />
<meta property="og:image:width" content="1500" />
<meta property="og:image:height" content="800" />
<meta property="og:description" content=""/>
<meta property="og:site_name" content="Makina States">
<link rel="apple-touch-icon" sizes="180x180" href="/images/favicons/apple-touch-icon.png">
<link rel="icon" type="image/png" href="/images/favicons/favicon-32x32.png" sizes="32x32">
<link rel="icon" type="image/png" href="/images/favicons/favicon-16x16.png" sizes="16x16">
<link rel="manifest" href="/images/favicons/manifest.json">
<link rel="mask-icon" href="/images/favicons/safari-pinned-tab.svg" color="#5bbad5">
<meta name="msapplication-TileColor" content="#da532c">
<meta name="msapplication-TileImage" content="/images/favicons/mstile-144x144.png">
<meta name="theme-color" content="#ffffff">
<link rel="shortcut icon" href="/images/favicons/favicon.ico">
<link rel="dns-prefetch" href="/">

<link rel="preconnect" href="/">
<link rel="canonical" href="/cloud/lxc.html">


<link rel="prefetch" href="/cloud.html">
<link rel="prerender" href="/cloud.html">


<link rel="stylesheet" href="/css/style.min.css">
  
</head>
<body>
	
<header id="site-header" class="site-header">
  <div class="hugo-meta" title="Hugo version 1">
    <a href="/" id="home-link">
      <img src="/images/MakinaCorpus_logo_vert_blanc.svg" alt="">
      </a>
    </div>
    <div class="header-content">
      <div class="header-list">
        <ul>
          <li>
            <a href="https://github.com/makinacorpus/makinastates/doc/hugo"
              target="_blank"><i class="icon-github"></i> Source</a>
          </li>
        </ul>
      </div>
    </div>
</header>


<a href="#" id="search-button" role="button">
	<span> Press <em>S</em> to search</span><i class="icon-search">
</i>
</a>
<form action=""
	id="site-search"
	class="search-form"
	role="search">
	<a href="#" id="close-search"><i class="icon-cancel"></i></a>
	<input type="search"
			id="search-input"
			aria-label="Search the Makina States website..."
			class="site-search"
			autocomplete="off"
			placeholder="Search documentation..." required>
		<ul id="search-results">
	         
		    
		</ul>
    <div class="press-escape"
         title="Press Escape to Close the Site Search Overlay">Press <em>ESC</em> to close.</div>
</form>

  <div class="all-content-wrapper" id="all-content-wrapper">
		
<span id="page-top"></span>
<main class="main">
	<article class="content" id="lxc-containers-management">
		<header class="content-header">
<nav class="breadcrumb">
	<ul class="breadcrumbs">
		<li>
			<a class="crumb" href="/cloud">
    		<span>Cloud</span>
  		</a>
		</li>
	</ul>
</nav>

<h1 class="page-title cloud" id="lxc-containers-management">LXC containers management</h1>
<div class="content-header-links">
  
  <a target="_blank" class="tooltip right edit-link" data-tooltip="Edit this page on GitHub" href="https://github.com/makinacorpus/makinastates/doc/hugoedit/master/content/cloud/lxc.md"><i class="icon-pencil" aria-hidden="true"></i></a></div>

	<ul class="tags">
		<li class="icon"><i class="icon-tags"></i></li>
		
		<li><a class="tag" href="/tags/cloud">cloud</a></li>
		
		<li><a class="tag" href="/tags/lxc">lxc</a></li>
		
	</ul>


		</header>
		<div class="body-copy" data-section=cloud>
		

<p>workflow:</p>

<ul>
<li>WARNING currently only those backing store are supported/tested:

<ul>
<li>dir</li>
<li>overlayfs</li>
</ul></li>
</ul>

<p>Go into makina-states folder:</p>

<pre><code class="language-sh">cd /srv/makina-states
</code></pre>

<p>Edit database:</p>

<pre><code class="language-sh">vim etc/makina-states/database.sls
</code></pre>

<p>Define shell variable to copy/paste following commands:</p>

<pre><code class="language-sh">export controller=&quot;$(hostname -f)&quot;
export cn=&quot;$(hostname -f)&quot;
# export cn=&quot;c.foo.net&quot;
export vm=&quot;d.foo.net&quot;
export vm_tmpl=&quot;makinastates&quot;
</code></pre>

<h2 id="preparation-on-the-controller">Preparation on the controller</h2>

<ul>
<li><p>Refresh cache:</p>

<pre><code class="language-sh"># bin/salt-call -lall \
#  state.sls makina-states.services.cache.memcached # the first time
service memcached restart
_scripts/refresh_makinastates_pillar.sh
# or with limit on hosts that the run will be
ANSIBLE_TARGETS=&quot;$controller,$vm,$cn&quot; _scripts/refresh_makinastates_pillar.sh
</code></pre></li>
</ul>

<h2 id="preinstalling-makina-states-controller-each-compute-node">Preinstalling makina-states (controller &amp; each compute node)</h2>

<ul>
<li><p>Installing it:</p>

<pre><code class="language-sh">ANSIBLE_TARGETS=&quot;$cn&quot; bin/ansible-playbook \
  ansible/plays/makinastates/install.yml
</code></pre></li>
</ul>

<h2 id="configure-the-dns-on-a-full-makina-states-infra-with-mc-pillar">Configure the dns on a full makina-states infra with mc_pillar</h2>

<pre><code class="language-sh">ANSIBLE_TARGETS=&quot;$controller&quot; bin/ansible-playbook \
  ansible/plays/cloud/controller.yml
</code></pre>

<h2 id="compute-node-related-part">Compute node related part</h2>

<p>Configure compute_node with:</p>

<pre><code class="language-sh">ANSIBLE_TARGETS=&quot;$cn&quot; ansible-playbook \
  ansible/plays/cloud/compute_node.yml
</code></pre>

<h2 id="cooking-and-delivery-of-container-container-templates">Cooking and delivery of container / container templates</h2>

<ul>
<li><p>Initialise a lxc container that will be the base of our image (after
creation go edit in it until sastified of the result):</p>

<pre><code class="language-sh">ANSIBLE_TARGETS=&quot;$controller,lxc$vm_tmpl&quot; bin/ansible-playbook \
  ansible/plays/cloud/create_container.yml
</code></pre></li>

<li><p>Synchronise it to an offline image, this will copy the container to the
image, and remove parts from it (like sshkeys) to impersonate it:</p>

<pre><code class="language-sh">ANSIBLE_TARGETS=&quot;$controller&quot; bin/ansible-playbook \
  ansible/plays/cloud/snapshot_container.yml -e &quot;lxc_template=$vm_tmpl lxc_container_name=lxc$vm_tmpl&quot;
</code></pre>

<ul>
<li><p>Arguments:</p>

<p>ANSIBLE_TARGETS</p>

<dl>
<dd>compute node where the container resides (must be in
ansible inventary)</dd>
<dt>lxc_template</dt>
<dd><p>lxc image to create</p></dd>
<dt>lxc_container_name</dt>
<dd><p>lxc container which serve as a base for the image</p></dd>
</dl></li>
</ul></li>

<li><p>Transfer the template to the compute node where you want to spawn
containers from that image:</p>

<pre><code>```sh
ANSIBLE_TARGETS=&quot;$cn&quot; ansible-playbook \
 ansible/plays/cloud/sync_container.yml \
     -e &quot;lxc_orig_host=$controller lxc_container_name=$vm_tmpl&quot;
```
</code></pre>

<ul>
<li><p>Arguments:</p>

<p>ANSIBLE_TARGETS</p>

<dl>
<dd>both orig and dest</dd>
<dt>lxc_host</dt>
<dd>where to transfer container/template</dd>
<dt>lxc_orig_host</dt>
<dd>where from transfer container/template</dd>
<dt>lxc_container_name</dt>
<dd>lxc container to transfer</dd>
</dl></li>
</ul></li>
</ul>

<h2 id="initialise-a-container">Initialise a container</h2>

<ul>
<li><p>Initialise and finish the container provisioning (from scratch)</p>

<pre><code class="language-sh">ANSIBLE_TARGETS=&quot;$cn,$vm&quot; bin/ansible-playbook \
  ansible/plays/cloud/create_container.yml
</code></pre></li>
</ul>

<p>Arguments:</p>

<pre><code>ANSIBLE_TARGETS
:   compute node where the container resides (must be in ansible
    inventary) &amp; lxc container to create

lxc_from_container
:   lxc container from which initing the container

lxc_backing_store
:   (opt) backing store to use
</code></pre>

<ul>
<li><p>Initialise and finish the container provisioning (from template):</p>

<pre><code class="language-sh">ANSIBLE_TARGETS=&quot;$cn,vm&quot; bin/ansible-playbook \
  ansible/plays/cloud/create_container.yml -e &quot;lxc_from_container=$vm_tmpl&quot;
</code></pre></li>

<li><p>Special case: use overlayfs to create the container:</p>

<pre><code class="language-sh">ANSIBLE_TARGETS=&quot;$cn,$vm&quot; bin/ansible-playbook \
 ansible/plays/cloud/create_container.yml \
  -e &quot;lxc_from_container=$vm_tmpl lxc_backing_store=overlayfs&quot;
</code></pre></li>
</ul>

		</div><div class="last-modified">Last Updated: 0001-01-01</div>
<footer id="content-footer">


<a href="/cloud.html" class="cf-link prev-page">
			<i class="fa fa-chevron-left"></i>
		<div class="page-info">
			<span>Previous</span>
			<h5 class="cloud">Cloud Documentation</h5>
		</div>
</a>



</footer>
</article>
</main>

<aside id="toc" class="scroll-fixed-wrapper">
  <div class="scroll-fixed-wrapper-inner">
    <header class="toc-header">
      <a href="#lxc-containers-management">
        <h3 class="cloud">LXC containers management</h3>
      </a>
    </header>
    <nav id="TableOfContents">
<ul>
<li>
<ul>
<li><a href="#preparation-on-the-controller">Preparation on the controller</a></li>
<li><a href="#preinstalling-makina-states-controller-each-compute-node">Preinstalling makina-states (controller &amp; each compute node)</a></li>
<li><a href="#configure-the-dns-on-a-full-makina-states-infra-with-mc-pillar">Configure the dns on a full makina-states infra with mc_pillar</a></li>
<li><a href="#compute-node-related-part">Compute node related part</a></li>
<li><a href="#cooking-and-delivery-of-container-container-templates">Cooking and delivery of container / container templates</a></li>
<li><a href="#initialise-a-container">Initialise a container</a></li>
</ul></li>
</ul>
</nav>
  </div>
  <div class="fade"></div>
</aside>
<a href="#"
  id="toc-toggle"
  class="toc-open"
  title="Toggle Table of contents..."></a>


	</div>
<footer id="site-footer" class="site-footer">
<div class="footer-content">
  
    
  </div>
</footer>
<div class="navbutton__wrapper">
  <a class="trigger" href="#">
    <ul class="nav__trigger">
      <li class="nav__trigger-item nav__trigger-item--first"></li>
      <li class="nav__trigger-item nav__trigger-item--second"></li>
      <li class="nav__trigger-item nav__trigger-item--third"></li>
    </ul>
  </a>
</div>
<nav class="site-navigation navigation-open scroll-fixed-wrapper"
     id="site-navigation">
  <div class="site-navigation-inner scroll-fixed-wrapper-inner">
    
    
    


<ul class="menu menu-1">

  
  
  


<li class="menu-item menu-item-1">
  <a
    class="list-icon menu-item-link menu-item-link-1" href="/">Home</a>
  
</li>

  
  
  

  
  
  


<li class="menu-item menu-item-1">
  <a
    class="list-icon menu-item-link menu-item-link-1 has-children" href="/topics/">Topics</a>
  
  
  


<ul class="menu menu-2">

  
  
  


<li class="menu-item menu-item-2">
  <a
    class="list-icon menu-item-link menu-item-link-2" href="/topics/ansible.html">Ansible related configuration</a>
  
</li>

  
  
  

  
  
  


<li class="menu-item menu-item-2">
  <a
    class="list-icon menu-item-link menu-item-link-2" href="/topics/configure.html">Configuration</a>
  
</li>

  
  
  

  
  
  


<li class="menu-item menu-item-2">
  <a
    class="list-icon menu-item-link menu-item-link-2" href="/topics/haproxy.html">Haproxy</a>
  
</li>

  
  
  

  
  
  


<li class="menu-item menu-item-2">
  <a
    class="list-icon menu-item-link menu-item-link-2" href="/topics/install.html">Installation &amp; basic usage</a>
  
</li>

  
  
  

  
  
  


<li class="menu-item menu-item-2">
  <a
    class="list-icon menu-item-link menu-item-link-2" href="/topics/ssl.html">Manage ssl certificates</a>
  
</li>

  
  
  

  
  
  


<li class="menu-item menu-item-2">
  <a
    class="list-icon menu-item-link menu-item-link-2" href="/topics/database.html">Minions managment via database.sls</a>
  
</li>

  
  
  

</ul>

  
  
</li>

  
  
  

  
  
  


<li class="menu-item menu-item-1">
  <a
    class="list-icon menu-item-link menu-item-link-1 has-children" href="/cloud/">Cloud</a>
  
  
  


<ul class="menu menu-2">

  
  
  


<li class="menu-item menu-item-2">
  <a
    class="list-icon menu-item-link menu-item-link-2 active open" href="/cloud/lxc.html">LXC containers management</a>
  
</li>

  
  
  

</ul>

  
  
</li>

  
  
  

</ul>

    
  </div>
</nav>
<script src="/js/vendor/jquery-2.2.4.min.js"></script>
<script src="/js/vendor/lunr.min.js"></script>
<script src="/js/script.min.js"></script>



<script async defer src="https://buttons.github.io/buttons.js"></script>

<script>
(function() {
  if (window.location.hostname === "localhost") {
    console.log("Analytics not running on local dev.");
    return;
  } else {
    (function(i, s, o, g, r, a, m) {
      i['GoogleAnalyticsObject'] = r;
      i[r] = i[r] || function() {
        (i[r].q = i[r].q || []).push(arguments)
      }, i[r].l = 1 * new Date();
      a = s.createElement(o),
        m = s.getElementsByTagName(o)[0];
      a.async = 1;
      a.src = g;
      m.parentNode.insertBefore(a, m)
    })(window, document, 'script', '//www.google-analytics.com/analytics.js', 'ga');

    ga('create', '', 'auto');
    ga('send', 'pageview');
    ga('create', '', {
      'siteSpeedSampleRate': 100
    });
  }
})();
</script>

	
</body>
</html>